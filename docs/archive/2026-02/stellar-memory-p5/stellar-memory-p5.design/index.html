
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Celestial-structure-based AI memory management">
      
      
      
        <link rel="canonical" href="https://stellar-memory.com/docs/archive/2026-02/stellar-memory-p5/stellar-memory-p5.design/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Design: stellar-memory-p5 (Advanced Intelligence & Scalability) - Stellar Memory</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#design-stellar-memory-p5-advanced-intelligence-scalability" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Stellar Memory" class="md-header__button md-logo" aria-label="Stellar Memory" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Stellar Memory
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Design: stellar-memory-p5 (Advanced Intelligence &amp; Scalability)
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/sangjun0000/stellar-memory" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    sangjun0000/stellar-memory
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Stellar Memory" class="md-nav__button md-logo" aria-label="Stellar Memory" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Stellar Memory
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/sangjun0000/stellar-memory" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    sangjun0000/stellar-memory
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../api-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../guides/chatbot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AI Chatbot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../guides/personal-assistant/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Personal Assistant
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../guides/code-assistant/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Code Assistant
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../guides/knowledge-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Knowledge Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    MCP Integration
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    MCP Integration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mcp/claude-code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Claude Code
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mcp/cursor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cursor
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mcp/tool-catalog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tool Catalog
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../rest-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    REST API
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Changelog
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-architecture-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Architecture Overview
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Architecture Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-new-component-diagram" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1 New Component Diagram
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-dependency-graph-p5-features" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2 Dependency Graph (P5 Features)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-feature-specifications" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Feature Specifications
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Feature Specifications">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#f1-multi-provider-llmembedder-support" class="md-nav__link">
    <span class="md-ellipsis">
      
        F1: Multi-Provider LLM/Embedder Support
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="F1: Multi-Provider LLM/Embedder Support">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#211-config-changes" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1.1 Config Changes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#212-providerregistry" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1.2 ProviderRegistry
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#213-openai-provider" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1.3 OpenAI Provider
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#214-ollama-provider" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1.4 Ollama Provider
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#215-integration-points" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1.5 Integration Points
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f2-vector-index-scalable-search" class="md-nav__link">
    <span class="md-ellipsis">
      
        F2: Vector Index (Scalable Search)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="F2: Vector Index (Scalable Search)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#221-config" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2.1 Config
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#222-vectorindex-interface" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2.2 VectorIndex Interface
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#223-bruteforceindex" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2.3 BruteForceIndex
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#224-balltreeindex" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2.4 BallTreeIndex
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#225-faissindex-optional" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2.5 FaissIndex (Optional)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#226-factory-function" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2.6 Factory Function
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#227-integration-into-stellarmemory" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2.7 Integration into StellarMemory
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f3-ai-memory-summarization" class="md-nav__link">
    <span class="md-ellipsis">
      
        F3: AI Memory Summarization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="F3: AI Memory Summarization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#231-config" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3.1 Config
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#232-memorysummarizer" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3.2 MemorySummarizer
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#233-stellarmemorystore-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3.3 StellarMemory.store() Integration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#234-new-events" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3.4 New Events
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#235-mcp-tool" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3.5 MCP Tool
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#236-cli-command" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3.6 CLI Command
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f4-adaptive-decay-importance-based-forgetting" class="md-nav__link">
    <span class="md-ellipsis">
      
        F4: Adaptive Decay (Importance-Based Forgetting)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="F4: Adaptive Decay (Importance-Based Forgetting)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#241-config" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.4.1 Config
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#242-adaptivedecaymanager" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.4.2 AdaptiveDecayManager
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#243-decaymanager-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.4.3 DecayManager Integration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#244-new-events" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.4.4 New Events
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f5-graph-analytics" class="md-nav__link">
    <span class="md-ellipsis">
      
        F5: Graph Analytics
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="F5: Graph Analytics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#251-config" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.5.1 Config
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#252-graphanalyzer" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.5.2 GraphAnalyzer
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#253-stellarmemory-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.5.3 StellarMemory Integration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#254-mcp-tool" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.5.4 MCP Tool
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#255-cli-commands" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.5.5 CLI Commands
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-models-newmodified" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Models (New/Modified)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-initpy-exports-v060" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. init.py Exports (v0.6.0)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-implementation-order-detailed-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Implementation Order (Detailed Steps)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-backward-compatibility" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Backward Compatibility
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-test-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. Test Strategy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Test Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#f1-test_providerspy-10-tests" class="md-nav__link">
    <span class="md-ellipsis">
      
        F1: test_providers.py (10+ tests)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f2-test_vector_indexpy-10-tests" class="md-nav__link">
    <span class="md-ellipsis">
      
        F2: test_vector_index.py (10+ tests)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f3-test_summarizerpy-10-tests" class="md-nav__link">
    <span class="md-ellipsis">
      
        F3: test_summarizer.py (10+ tests)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f4-test_adaptive_decaypy-8-tests" class="md-nav__link">
    <span class="md-ellipsis">
      
        F4: test_adaptive_decay.py (8+ tests)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f5-test_graph_analyzerpy-10-tests" class="md-nav__link">
    <span class="md-ellipsis">
      
        F5: test_graph_analyzer.py (10+ tests)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-performance-targets" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. Performance Targets
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="design-stellar-memory-p5-advanced-intelligence-scalability">Design: stellar-memory-p5 (Advanced Intelligence &amp; Scalability)</h1>
<p><strong>Version</strong>: v0.6.0
<strong>Plan Reference</strong>: <code>docs/01-plan/features/stellar-memory-p5.plan.md</code>
<strong>Previous</strong>: v0.5.0 (26 source files, 237 tests, 98% avg match rate)</p>
<hr />
<h2 id="1-architecture-overview">1. Architecture Overview</h2>
<h3 id="11-new-component-diagram">1.1 New Component Diagram</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>StellarMemory (stellar.py)
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>├── ProviderRegistry (providers/)          ← F1: NEW
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>│   ├── AnthropicProvider (built-in)
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>│   ├── OpenAIProvider (optional)
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>│   └── OllamaProvider (optional)
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>├── VectorIndex (vector_index.py)          ← F2: NEW
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>│   ├── BruteForceIndex (default)
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>│   ├── BallTreeIndex (built-in)
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>│   └── FaissIndex (optional)
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>├── MemorySummarizer (summarizer.py)       ← F3: NEW
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>├── AdaptiveDecayManager (adaptive_decay.py) ← F4: NEW
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>├── GraphAnalyzer (graph_analyzer.py)      ← F5: NEW
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>│
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>├── MemoryFunction (memory_function.py)    ← existing
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>├── Embedder / NullEmbedder (embedder.py)  ← modified
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>├── LLMEvaluator (importance_evaluator.py) ← modified
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>├── OrbitManager (orbit_manager.py)        ← existing
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>├── PersistentGraph (persistent_graph.py)  ← existing
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>├── DecayManager (decay_manager.py)        ← modified
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>├── EventBus (event_bus.py)                ← modified
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>├── EventLogger (event_logger.py)          ← existing
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>├── SessionManager (session.py)            ← existing
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>├── Consolidator (consolidator.py)         ← existing
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>└── Scheduler (scheduler.py)              ← existing
</code></pre></div>
<h3 id="12-dependency-graph-p5-features">1.2 Dependency Graph (P5 Features)</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>F1 Multi-Provider ──→ F3 AI Summarization (needs LLM)
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>                  ──→ importance_evaluator (OpenAI/Ollama support)
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>F2 Vector Index   ──→ stellar.py auto_link + recall (performance)
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>F4 Adaptive Decay ──→ decay_manager (extends existing)
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>F5 Graph Analytics ──→ persistent_graph / memory_graph (reads graph)
</code></pre></div>
<hr />
<h2 id="2-feature-specifications">2. Feature Specifications</h2>
<h3 id="f1-multi-provider-llmembedder-support">F1: Multi-Provider LLM/Embedder Support</h3>
<h4 id="211-config-changes">2.1.1 Config Changes</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># config.py additions</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="nd">@dataclass</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">EmbedderConfig</span><span class="p">:</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;all-MiniLM-L6-v2&quot;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>    <span class="n">dimension</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">384</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>    <span class="n">provider</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sentence-transformers&quot;</span>  <span class="c1"># NEW: &quot;sentence-transformers&quot; | &quot;openai&quot; | &quot;ollama&quot;</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="nd">@dataclass</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">LLMConfig</span><span class="p">:</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>    <span class="n">provider</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;anthropic&quot;</span>  <span class="c1"># existing: &quot;anthropic&quot; | &quot;openai&quot; | &quot;ollama&quot;</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;claude-haiku-4-5-20251001&quot;</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>    <span class="n">api_key_env</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ANTHROPIC_API_KEY&quot;</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>    <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># NEW: for Ollama custom endpoint</span>
</code></pre></div>
<h4 id="212-providerregistry">2.1.2 ProviderRegistry</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># providers/__init__.py</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Protocol</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">LLMProvider</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Protocol for LLM providers.&quot;&quot;&quot;</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">EmbedderProvider</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Protocol for embedding providers.&quot;&quot;&quot;</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">embed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span> <span class="o">...</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">embed_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span> <span class="o">...</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">ProviderRegistry</span><span class="p">:</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Registry for LLM and Embedder providers.&quot;&quot;&quot;</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>    <span class="n">_llm_factories</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>    <span class="n">_embedder_factories</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">register_llm</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">factory</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">register_embedder</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">factory</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_llm</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">LLMConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMProvider</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_embedder</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">EmbedderConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EmbedderProvider</span><span class="p">:</span> <span class="o">...</span>
</code></pre></div>
<p>Auto-register on import:
- <code>"anthropic"</code> → existing AnthropicProvider (from importance_evaluator.py logic)
- <code>"openai"</code> → OpenAIProvider (try import openai, fallback to NullProvider)
- <code>"ollama"</code> → OllamaProvider (try import ollama, fallback to NullProvider)
- <code>"sentence-transformers"</code> → existing Embedder class
- <code>"rule"</code> → existing RuleBasedEvaluator (no LLM needed)</p>
<h4 id="213-openai-provider">2.1.3 OpenAI Provider</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># providers/openai_provider.py</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">OpenAILLMProvider</span><span class="p">:</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;OpenAI GPT-based LLM provider.&quot;&quot;&quot;</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">LLMConfig</span><span class="p">):</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># lazy init</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Call OpenAI chat completions API.&quot;&quot;&quot;</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAI</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>            <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">api_key_env</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">model</span> <span class="ow">or</span> <span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>            <span class="n">max_tokens</span><span class="o">=</span><span class="n">max_tokens</span><span class="p">,</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>            <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>        <span class="p">)</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="k">class</span><span class="w"> </span><span class="nc">OpenAIEmbedderProvider</span><span class="p">:</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;OpenAI text-embedding provider.&quot;&quot;&quot;</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">EmbedderConfig</span><span class="p">):</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">embed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAI</span>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">embeddings</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">model_name</span> <span class="ow">or</span> <span class="s2">&quot;text-embedding-3-small&quot;</span><span class="p">,</span>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>            <span class="nb">input</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>        <span class="p">)</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">embedding</span>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">embed_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAI</span>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">embeddings</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">model_name</span> <span class="ow">or</span> <span class="s2">&quot;text-embedding-3-small&quot;</span><span class="p">,</span>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>            <span class="nb">input</span><span class="o">=</span><span class="n">texts</span><span class="p">,</span>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>        <span class="p">)</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">embedding</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
</code></pre></div>
<h4 id="214-ollama-provider">2.1.4 Ollama Provider</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># providers/ollama_provider.py</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">OllamaLLMProvider</span><span class="p">:</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Ollama local LLM provider.&quot;&quot;&quot;</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">LLMConfig</span><span class="p">):</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">base_url</span> <span class="ow">or</span> <span class="s2">&quot;http://localhost:11434&quot;</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Call Ollama generate API.&quot;&quot;&quot;</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span><span class="si">}</span><span class="s2">/api/generate&quot;</span><span class="p">,</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>            <span class="n">json</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">model</span> <span class="ow">or</span> <span class="s2">&quot;llama3&quot;</span><span class="p">,</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>                <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>                <span class="s2">&quot;stream&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>                <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;num_predict&quot;</span><span class="p">:</span> <span class="n">max_tokens</span><span class="p">},</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>            <span class="p">},</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>        <span class="p">)</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a><span class="k">class</span><span class="w"> </span><span class="nc">OllamaEmbedderProvider</span><span class="p">:</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Ollama local embedding provider.&quot;&quot;&quot;</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">EmbedderConfig</span><span class="p">):</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:11434&quot;</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">embed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span><span class="si">}</span><span class="s2">/api/embed&quot;</span><span class="p">,</span>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>            <span class="n">json</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">model_name</span> <span class="ow">or</span> <span class="s2">&quot;nomic-embed-text&quot;</span><span class="p">,</span>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>                <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>            <span class="p">},</span>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>        <span class="p">)</span>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;embeddings&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">embed_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a>        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>
</code></pre></div>
<h4 id="215-integration-points">2.1.5 Integration Points</h4>
<p><strong>importance_evaluator.py</strong> changes:
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># LLMEvaluator._call_llm() currently has:</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="c1">#   if self._config.provider == &quot;anthropic&quot;: ...</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="c1">#   else: raise ValueError(...)</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="c1">#</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="c1"># Change to use ProviderRegistry:</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">_call_llm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EvaluationResult</span><span class="p">:</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">stellar_memory.providers</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProviderRegistry</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>    <span class="n">llm</span> <span class="o">=</span> <span class="n">ProviderRegistry</span><span class="o">.</span><span class="n">create_llm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">)</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>    <span class="n">raw</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">max_tokens</span><span class="p">)</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>    <span class="c1"># ... parse JSON response (same logic)</span>
</code></pre></div></p>
<p><strong>create_evaluator()</strong> changes:
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_evaluator</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">LLMConfig</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>    <span class="n">cfg</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">LLMConfig</span><span class="p">()</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>        <span class="k">return</span> <span class="n">NullEvaluator</span><span class="p">()</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>    <span class="c1"># Try to create provider via registry</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">stellar_memory.providers</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProviderRegistry</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>        <span class="n">ProviderRegistry</span><span class="o">.</span><span class="n">create_llm</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>  <span class="c1"># test if provider is available</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>        <span class="k">return</span> <span class="n">LLMEvaluator</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>        <span class="k">return</span> <span class="n">RuleBasedEvaluator</span><span class="p">()</span>
</code></pre></div></p>
<p><strong>embedder.py</strong> changes:
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_embedder</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">EmbedderConfig</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>    <span class="n">cfg</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">EmbedderConfig</span><span class="p">()</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>        <span class="k">return</span> <span class="n">NullEmbedder</span><span class="p">()</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="s2">&quot;sentence-transformers&quot;</span><span class="p">:</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>        <span class="c1"># existing logic</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">sentence_transformers</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>            <span class="k">return</span> <span class="n">Embedder</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>            <span class="k">return</span> <span class="n">NullEmbedder</span><span class="p">()</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>        <span class="c1"># Use ProviderRegistry for openai/ollama</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">stellar_memory.providers</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProviderRegistry</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>            <span class="k">return</span> <span class="n">ProviderRegistry</span><span class="o">.</span><span class="n">create_embedder</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>            <span class="k">return</span> <span class="n">NullEmbedder</span><span class="p">()</span>
</code></pre></div></p>
<hr />
<h3 id="f2-vector-index-scalable-search">F2: Vector Index (Scalable Search)</h3>
<h4 id="221-config">2.2.1 Config</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># config.py addition</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="nd">@dataclass</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">VectorIndexConfig</span><span class="p">:</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>    <span class="n">backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;brute_force&quot;</span>  <span class="c1"># &quot;brute_force&quot; | &quot;ball_tree&quot; | &quot;faiss&quot;</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>    <span class="n">rebuild_on_start</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>    <span class="n">ball_tree_leaf_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span>
</code></pre></div>
<p>Add to StellarConfig:
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">vector_index</span><span class="p">:</span> <span class="n">VectorIndexConfig</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">VectorIndexConfig</span><span class="p">)</span>
</code></pre></div></p>
<h4 id="222-vectorindex-interface">2.2.2 VectorIndex Interface</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1"># vector_index.py</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">VectorIndex</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base for vector search indices.&quot;&quot;&quot;</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vector</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_vector</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns list of (item_id, similarity_score) sorted descending.&quot;&quot;&quot;</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>        <span class="o">...</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">rebuild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Rebuild index from scratch.&quot;&quot;&quot;</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>        <span class="k">for</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">vector</span> <span class="ow">in</span> <span class="n">items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item_id</span><span class="p">,</span> <span class="n">vector</span><span class="p">)</span>
</code></pre></div>
<h4 id="223-bruteforceindex">2.2.3 BruteForceIndex</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">BruteForceIndex</span><span class="p">(</span><span class="n">VectorIndex</span><span class="p">):</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;O(n) brute force search - wraps existing cosine_similarity.&quot;&quot;&quot;</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vector</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">vector</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">item_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_vector</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">stellar_memory.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">cosine_similarity</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>        <span class="k">for</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">vec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>            <span class="n">sim</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">query_vector</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">item_id</span><span class="p">,</span> <span class="n">sim</span><span class="p">))</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>        <span class="n">scores</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>        <span class="k">return</span> <span class="n">scores</span><span class="p">[:</span><span class="n">top_k</span><span class="p">]</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span><span class="p">)</span>
</code></pre></div>
<h4 id="224-balltreeindex">2.2.4 BallTreeIndex</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">BallTreeIndex</span><span class="p">(</span><span class="n">VectorIndex</span><span class="p">):</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Ball-Tree based approximate nearest neighbor search.</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="sd">    Pure Python implementation, no external dependencies.</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="sd">    O(log n) average case search.&quot;&quot;&quot;</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">leaf_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span><span class="p">):</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_leaf_size</span> <span class="o">=</span> <span class="n">leaf_size</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># rebuilt lazily</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vector</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">vector</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">item_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_vector</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_build_tree</span><span class="p">()</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree_search</span><span class="p">(</span><span class="n">query_vector</span><span class="p">,</span> <span class="n">top_k</span><span class="p">)</span>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Build ball tree from current vectors.&quot;&quot;&quot;</span>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a>        <span class="c1"># Implementation: recursive binary tree splitting by dimension</span>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a>        <span class="c1"># Each leaf node holds up to leaf_size vectors</span>
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a>        <span class="c1"># Internal nodes hold centroid + radius for pruning</span>
<a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>        <span class="o">...</span>
<a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a>
<a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_tree_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Search tree using branch-and-bound with cosine similarity.&quot;&quot;&quot;</span>
<a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a>        <span class="o">...</span>
<a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a>
<a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span><span class="p">)</span>
<a id="__codelineno-13-39" name="__codelineno-13-39" href="#__codelineno-13-39"></a>
<a id="__codelineno-13-40" name="__codelineno-13-40" href="#__codelineno-13-40"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">rebuild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-13-41" name="__codelineno-13-41" href="#__codelineno-13-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
<a id="__codelineno-13-42" name="__codelineno-13-42" href="#__codelineno-13-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>
<p><strong>BallTree Node Structure</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nd">@dataclass</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">_BallTreeNode</span><span class="p">:</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>    <span class="n">centroid</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>    <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>    <span class="n">item_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>     <span class="c1"># leaf node</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>    <span class="n">vectors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># leaf node</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>    <span class="n">left</span><span class="p">:</span> <span class="n">_BallTreeNode</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># internal</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>    <span class="n">right</span><span class="p">:</span> <span class="n">_BallTreeNode</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>     <span class="c1"># internal</span>
</code></pre></div></p>
<h4 id="225-faissindex-optional">2.2.5 FaissIndex (Optional)</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># faiss_index.py (separate file - optional dependency)</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">FaissIndex</span><span class="p">(</span><span class="n">VectorIndex</span><span class="p">):</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;FAISS-based index for large-scale vector search (100k+).&quot;&quot;&quot;</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimension</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">384</span><span class="p">):</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">faiss</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dimension</span> <span class="o">=</span> <span class="n">dimension</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">IndexFlatIP</span><span class="p">(</span><span class="n">dimension</span><span class="p">)</span>  <span class="c1"># inner product (cosine for normalized)</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_id_map</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vector</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_vector</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span> <span class="o">...</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="o">.</span><span class="n">ntotal</span>
</code></pre></div>
<h4 id="226-factory-function">2.2.6 Factory Function</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_vector_index</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">VectorIndexConfig</span><span class="p">,</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>                        <span class="n">dimension</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">384</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VectorIndex</span><span class="p">:</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>        <span class="k">return</span> <span class="n">BruteForceIndex</span><span class="p">()</span>  <span class="c1"># minimal overhead when disabled</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;ball_tree&quot;</span><span class="p">:</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>        <span class="k">return</span> <span class="n">BallTreeIndex</span><span class="p">(</span><span class="n">leaf_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">ball_tree_leaf_size</span><span class="p">)</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>    <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;faiss&quot;</span><span class="p">:</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">stellar_memory.faiss_index</span><span class="w"> </span><span class="kn">import</span> <span class="n">FaissIndex</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>            <span class="k">return</span> <span class="n">FaissIndex</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="n">dimension</span><span class="p">)</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;faiss not installed, falling back to BallTreeIndex&quot;</span><span class="p">)</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>            <span class="k">return</span> <span class="n">BallTreeIndex</span><span class="p">(</span><span class="n">leaf_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">ball_tree_leaf_size</span><span class="p">)</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>        <span class="k">return</span> <span class="n">BruteForceIndex</span><span class="p">()</span>
</code></pre></div>
<h4 id="227-integration-into-stellarmemory">2.2.7 Integration into StellarMemory</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1"># stellar.py __init__ additions:</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="bp">self</span><span class="o">.</span><span class="n">_vector_index</span> <span class="o">=</span> <span class="n">create_vector_index</span><span class="p">(</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">vector_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">embedder</span><span class="o">.</span><span class="n">dimension</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="p">)</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="c1"># _auto_link() change:</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">_auto_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">MemoryItem</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">embedding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>        <span class="k">return</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>    <span class="c1"># Register in vector index</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_vector_index</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">embedding</span><span class="p">)</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>    <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">auto_link_threshold</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>    <span class="c1"># Use index instead of O(n) scan</span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>    <span class="n">candidates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vector_index</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">embedding</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>    <span class="k">for</span> <span class="n">other_id</span><span class="p">,</span> <span class="n">sim</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>        <span class="k">if</span> <span class="n">other_id</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>            <span class="k">continue</span>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>        <span class="k">if</span> <span class="n">sim</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">other_id</span><span class="p">,</span> <span class="s2">&quot;related_to&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">sim</span><span class="p">)</span>
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a><span class="c1"># store() addition: register embedding in index</span>
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a><span class="c1"># forget() addition: remove from index</span>
<a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a><span class="c1"># import_json() addition: rebuild index after import</span>
</code></pre></div>
<hr />
<h3 id="f3-ai-memory-summarization">F3: AI Memory Summarization</h3>
<h4 id="231-config">2.3.1 Config</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># config.py addition</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="nd">@dataclass</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">SummarizationConfig</span><span class="p">:</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>    <span class="n">min_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>       <span class="c1"># minimum content length to trigger summarization</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>    <span class="n">max_summary_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span>  <span class="c1"># target summary length</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>    <span class="n">importance_boost</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># summary gets +0.1 importance vs original</span>
</code></pre></div>
<p>Add to StellarConfig:
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">summarization</span><span class="p">:</span> <span class="n">SummarizationConfig</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">SummarizationConfig</span><span class="p">)</span>
</code></pre></div></p>
<h4 id="232-memorysummarizer">2.3.2 MemorySummarizer</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1"># summarizer.py</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">MemorySummarizer</span><span class="p">:</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;AI-powered memory summarization.&quot;&quot;&quot;</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>    <span class="n">PROMPT_TEMPLATE</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>        <span class="s2">&quot;Summarize the following text in one concise sentence &quot;</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>        <span class="s2">&quot;(max </span><span class="si">{max_len}</span><span class="s2"> characters). Keep only the essential facts, &quot;</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>        <span class="s2">&quot;dates, names, and action items.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>        <span class="s2">&quot;Text: </span><span class="si">{content}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>        <span class="s2">&quot;Summary:&quot;</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>    <span class="p">)</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">SummarizationConfig</span><span class="p">,</span> <span class="n">llm_config</span><span class="p">:</span> <span class="n">LLMConfig</span><span class="p">):</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_llm_config</span> <span class="o">=</span> <span class="n">llm_config</span>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_llm</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># lazy init via ProviderRegistry</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">should_summarize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if content is long enough to warrant summarization.&quot;&quot;&quot;</span>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a>        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">enabled</span>
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">min_length</span><span class="p">)</span>
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a>
<a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">summarize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a summary of the content using LLM.</span>
<a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a><span class="sd">        Returns None if summarization fails or is disabled.&quot;&quot;&quot;</span>
<a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_summarize</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
<a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a>                <span class="kn">from</span><span class="w"> </span><span class="nn">stellar_memory.providers</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProviderRegistry</span>
<a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_llm</span> <span class="o">=</span> <span class="n">ProviderRegistry</span><span class="o">.</span><span class="n">create_llm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_llm_config</span><span class="p">)</span>
<a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a>            <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROMPT_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a>                <span class="n">max_len</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">max_summary_length</span><span class="p">,</span>
<a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a>                <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
<a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a>            <span class="p">)</span>
<a id="__codelineno-20-37" name="__codelineno-20-37" href="#__codelineno-20-37"></a>            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llm</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">max_tokens</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">max_summary_length</span><span class="p">)</span>
<a id="__codelineno-20-38" name="__codelineno-20-38" href="#__codelineno-20-38"></a>            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">max_summary_length</span><span class="p">]</span>
<a id="__codelineno-20-39" name="__codelineno-20-39" href="#__codelineno-20-39"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-20-40" name="__codelineno-20-40" href="#__codelineno-20-40"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Summarization failed, storing original&quot;</span><span class="p">)</span>
<a id="__codelineno-20-41" name="__codelineno-20-41" href="#__codelineno-20-41"></a>            <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
<h4 id="233-stellarmemorystore-integration">2.3.3 StellarMemory.store() Integration</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">importance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>          <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>          <span class="n">auto_evaluate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>          <span class="n">skip_summarize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MemoryItem</span><span class="p">:</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>    <span class="c1"># ... existing evaluation + embedding logic ...</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>    <span class="c1"># NEW: Summarization pipeline</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">skip_summarize</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summarizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summarizer</span><span class="o">.</span><span class="n">should_summarize</span><span class="p">(</span><span class="n">content</span><span class="p">)):</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>        <span class="n">summary_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summarizer</span><span class="o">.</span><span class="n">summarize</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>        <span class="k">if</span> <span class="n">summary_text</span><span class="p">:</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>            <span class="c1"># Store summary as a separate high-priority item</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>            <span class="n">summary_importance</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">importance</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">summarization</span><span class="o">.</span><span class="n">importance_boost</span><span class="p">)</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>            <span class="n">summary_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">(</span>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>                <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;[Summary] </span><span class="si">{</span><span class="n">summary_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>                <span class="n">importance</span><span class="o">=</span><span class="n">summary_importance</span><span class="p">,</span>
<a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="o">**</span><span class="p">(</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{}),</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;original_length&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)},</span>
<a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>                <span class="n">skip_summarize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># prevent recursion</span>
<a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>            <span class="p">)</span>
<a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a>            <span class="c1"># Store original at lower zone</span>
<a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store_internal</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">importance</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">auto_evaluate</span><span class="p">)</span>
<a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>            <span class="c1"># Link summary → original with derived_from edge</span>
<a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
<a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">summary_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;derived_from&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_event_bus</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;on_summarize&quot;</span><span class="p">,</span> <span class="n">summary_item</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
<a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a>            <span class="k">return</span> <span class="n">summary_item</span>  <span class="c1"># return the summary as primary reference</span>
<a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a>
<a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store_internal</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">importance</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">auto_evaluate</span><span class="p">)</span>
</code></pre></div>
<h4 id="234-new-events">2.3.4 New Events</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1"># event_bus.py EVENTS tuple addition:</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="s2">&quot;on_summarize&quot;</span><span class="p">,</span>       <span class="c1"># (summary_item, original_item)</span>
</code></pre></div>
<h4 id="235-mcp-tool">2.3.5 MCP Tool</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># mcp_server.py addition</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="nd">@mcp</span><span class="o">.</span><span class="n">tool</span><span class="p">()</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">memory_summarize</span><span class="p">(</span><span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Manually summarize an existing memory.</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="sd">    Args:</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="sd">        memory_id: The UUID of the memory to summarize</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>    <span class="n">item</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">memory_id</span><span class="p">)</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>    <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Memory not found&quot;</span><span class="p">})</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>    <span class="k">if</span> <span class="n">memory</span><span class="o">.</span><span class="n">_summarizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Summarization not configured&quot;</span><span class="p">})</span>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>    <span class="n">summary</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">_summarizer</span><span class="o">.</span><span class="n">summarize</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>    <span class="k">if</span> <span class="n">summary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Summarization failed&quot;</span><span class="p">})</span>
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>    <span class="n">summary_item</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">store</span><span class="p">(</span>
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>        <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;[Summary] </span><span class="si">{</span><span class="n">summary</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>        <span class="n">importance</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">arbitrary_importance</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">),</span>
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;source_id&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">},</span>
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a>        <span class="n">skip_summarize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a>    <span class="p">)</span>
<a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a>    <span class="k">if</span> <span class="n">memory</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
<a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a>        <span class="n">memory</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">summary_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;derived_from&quot;</span><span class="p">)</span>
<a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a>    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
<a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a>        <span class="s2">&quot;summary_id&quot;</span><span class="p">:</span> <span class="n">summary_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a>        <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">summary</span><span class="p">,</span>
<a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a>        <span class="s2">&quot;original_id&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a>    <span class="p">})</span>
</code></pre></div>
<h4 id="236-cli-command">2.3.6 CLI Command</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="c1"># cli.py addition</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="c1"># summarize subparser</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="n">p_summarize</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;summarize&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Summarize a memory&quot;</span><span class="p">)</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="n">p_summarize</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Memory ID to summarize&quot;</span><span class="p">)</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="c1"># handler</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;summarize&quot;</span><span class="p">:</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>    <span class="n">item</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>    <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Memory not found&quot;</span><span class="p">)</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>        <span class="k">return</span>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>    <span class="k">if</span> <span class="n">memory</span><span class="o">.</span><span class="n">_summarizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Summarization not available (LLM not configured)&quot;</span><span class="p">)</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>        <span class="k">return</span>
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a>    <span class="n">summary</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">_summarizer</span><span class="o">.</span><span class="n">summarize</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a>    <span class="k">if</span> <span class="n">summary</span><span class="p">:</span>
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Summary: </span><span class="si">{</span><span class="n">summary</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not generate summary&quot;</span><span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="f4-adaptive-decay-importance-based-forgetting">F4: Adaptive Decay (Importance-Based Forgetting)</h3>
<h4 id="241-config">2.4.1 Config</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1"># config.py addition</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="nd">@dataclass</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">AdaptiveDecayConfig</span><span class="p">:</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># opt-in, disabled by default</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>    <span class="n">importance_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>    <span class="n">decay_curve</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;linear&quot;</span>  <span class="c1"># &quot;linear&quot; | &quot;exponential&quot; | &quot;sigmoid&quot;</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>    <span class="n">zone_factor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># closer zones decay slower</span>
</code></pre></div>
<p>Add to DecayConfig:
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="nd">@dataclass</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">DecayConfig</span><span class="p">:</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>    <span class="n">decay_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>    <span class="n">auto_forget_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">90</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>    <span class="n">min_zone_for_decay</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>    <span class="n">adaptive</span><span class="p">:</span> <span class="n">AdaptiveDecayConfig</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">AdaptiveDecayConfig</span><span class="p">)</span>  <span class="c1"># NEW</span>
</code></pre></div></p>
<h4 id="242-adaptivedecaymanager">2.4.2 AdaptiveDecayManager</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1"># adaptive_decay.py</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">stellar_memory.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">DecayConfig</span><span class="p">,</span> <span class="n">AdaptiveDecayConfig</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">stellar_memory.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">MemoryItem</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="n">SECONDS_PER_DAY</span> <span class="o">=</span> <span class="mi">86400</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">AdaptiveDecayManager</span><span class="p">:</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Importance-based differential decay rates.&quot;&quot;&quot;</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decay_config</span><span class="p">:</span> <span class="n">DecayConfig</span><span class="p">):</span>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">decay_config</span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_adaptive</span> <span class="o">=</span> <span class="n">decay_config</span><span class="o">.</span><span class="n">adaptive</span>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">effective_decay_days</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">MemoryItem</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate effective decay days based on importance.</span>
<a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a>
<a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="sd">        Formula: base_days * (0.5 + importance * weight)</span>
<a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a><span class="sd">        - importance=0.9, weight=1.0 → 30 * 1.4 = 42 days</span>
<a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a><span class="sd">        - importance=0.3, weight=1.0 → 30 * 0.8 = 24 days</span>
<a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a><span class="sd">        - importance=0.0, weight=1.0 → 30 * 0.5 = 15 days</span>
<a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a>        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">decay_days</span>
<a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a>        <span class="n">importance</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">arbitrary_importance</span>
<a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a>        <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adaptive</span><span class="o">.</span><span class="n">importance_weight</span>
<a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a>        <span class="n">factor</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">importance</span> <span class="o">*</span> <span class="n">weight</span>
<a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a>
<a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adaptive</span><span class="o">.</span><span class="n">zone_factor</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">zone</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a>            <span class="c1"># Closer zones (smaller zone_id) decay slower</span>
<a id="__codelineno-27-32" name="__codelineno-27-32" href="#__codelineno-27-32"></a>            <span class="c1"># zone 2: * 1.5, zone 3: * 1.0, zone 4: * 0.75</span>
<a id="__codelineno-27-33" name="__codelineno-27-33" href="#__codelineno-27-33"></a>            <span class="n">zone_multiplier</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">item</span><span class="o">.</span><span class="n">zone</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
<a id="__codelineno-27-34" name="__codelineno-27-34" href="#__codelineno-27-34"></a>            <span class="n">factor</span> <span class="o">*=</span> <span class="n">zone_multiplier</span>
<a id="__codelineno-27-35" name="__codelineno-27-35" href="#__codelineno-27-35"></a>
<a id="__codelineno-27-36" name="__codelineno-27-36" href="#__codelineno-27-36"></a>        <span class="k">return</span> <span class="n">base</span> <span class="o">*</span> <span class="n">factor</span>
<a id="__codelineno-27-37" name="__codelineno-27-37" href="#__codelineno-27-37"></a>
<a id="__codelineno-27-38" name="__codelineno-27-38" href="#__codelineno-27-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">effective_forget_days</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">MemoryItem</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-27-39" name="__codelineno-27-39" href="#__codelineno-27-39"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate effective auto-forget days.&quot;&quot;&quot;</span>
<a id="__codelineno-27-40" name="__codelineno-27-40" href="#__codelineno-27-40"></a>        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">auto_forget_days</span>
<a id="__codelineno-27-41" name="__codelineno-27-41" href="#__codelineno-27-41"></a>        <span class="n">importance</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">arbitrary_importance</span>
<a id="__codelineno-27-42" name="__codelineno-27-42" href="#__codelineno-27-42"></a>        <span class="k">return</span> <span class="n">base</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">importance</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adaptive</span><span class="o">.</span><span class="n">importance_weight</span><span class="p">)</span>
<a id="__codelineno-27-43" name="__codelineno-27-43" href="#__codelineno-27-43"></a>
<a id="__codelineno-27-44" name="__codelineno-27-44" href="#__codelineno-27-44"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">apply_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elapsed_days</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">threshold_days</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-27-45" name="__codelineno-27-45" href="#__codelineno-27-45"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply decay curve to determine decay severity.</span>
<a id="__codelineno-27-46" name="__codelineno-27-46" href="#__codelineno-27-46"></a><span class="sd">        Returns 0.0 (no decay) to 1.0 (full decay).&quot;&quot;&quot;</span>
<a id="__codelineno-27-47" name="__codelineno-27-47" href="#__codelineno-27-47"></a>        <span class="k">if</span> <span class="n">elapsed_days</span> <span class="o">&lt;</span> <span class="n">threshold_days</span><span class="p">:</span>
<a id="__codelineno-27-48" name="__codelineno-27-48" href="#__codelineno-27-48"></a>            <span class="k">return</span> <span class="mf">0.0</span>
<a id="__codelineno-27-49" name="__codelineno-27-49" href="#__codelineno-27-49"></a>        <span class="n">ratio</span> <span class="o">=</span> <span class="n">elapsed_days</span> <span class="o">/</span> <span class="n">threshold_days</span>
<a id="__codelineno-27-50" name="__codelineno-27-50" href="#__codelineno-27-50"></a>
<a id="__codelineno-27-51" name="__codelineno-27-51" href="#__codelineno-27-51"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adaptive</span><span class="o">.</span><span class="n">decay_curve</span> <span class="o">==</span> <span class="s2">&quot;exponential&quot;</span><span class="p">:</span>
<a id="__codelineno-27-52" name="__codelineno-27-52" href="#__codelineno-27-52"></a>            <span class="k">return</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">ratio</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">))</span>
<a id="__codelineno-27-53" name="__codelineno-27-53" href="#__codelineno-27-53"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adaptive</span><span class="o">.</span><span class="n">decay_curve</span> <span class="o">==</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">:</span>
<a id="__codelineno-27-54" name="__codelineno-27-54" href="#__codelineno-27-54"></a>            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>  <span class="c1"># steepness factor</span>
<a id="__codelineno-27-55" name="__codelineno-27-55" href="#__codelineno-27-55"></a>            <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">))</span>
<a id="__codelineno-27-56" name="__codelineno-27-56" href="#__codelineno-27-56"></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># linear</span>
<a id="__codelineno-27-57" name="__codelineno-27-57" href="#__codelineno-27-57"></a>            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ratio</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
</code></pre></div>
<h4 id="243-decaymanager-integration">2.4.3 DecayManager Integration</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="c1"># decay_manager.py changes</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">DecayManager</span><span class="p">:</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">DecayConfig</span><span class="p">):</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_adaptive</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">adaptive</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">stellar_memory.adaptive_decay</span><span class="w"> </span><span class="kn">import</span> <span class="n">AdaptiveDecayManager</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_adaptive</span> <span class="o">=</span> <span class="n">AdaptiveDecayManager</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_decay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">MemoryItem</span><span class="p">],</span>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a>                    <span class="n">current_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DecayResult</span><span class="p">:</span>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">DecayResult</span><span class="p">()</span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a>            <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a>
<a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
<a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a>            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">zone</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">min_zone_for_decay</span><span class="p">:</span>
<a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a>                <span class="k">continue</span>
<a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a>
<a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adaptive</span><span class="p">:</span>
<a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a>                <span class="n">decay_days</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adaptive</span><span class="o">.</span><span class="n">effective_decay_days</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a>                <span class="n">forget_days</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adaptive</span><span class="o">.</span><span class="n">effective_forget_days</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a>                <span class="n">decay_days</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">decay_days</span>
<a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a>                <span class="n">forget_days</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">auto_forget_days</span>
<a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a>
<a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a>            <span class="n">decay_threshold</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="p">(</span><span class="n">decay_days</span> <span class="o">*</span> <span class="n">SECONDS_PER_DAY</span><span class="p">)</span>
<a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a>            <span class="n">forget_threshold</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="p">(</span><span class="n">forget_days</span> <span class="o">*</span> <span class="n">SECONDS_PER_DAY</span><span class="p">)</span>
<a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a>
<a id="__codelineno-28-31" name="__codelineno-28-31" href="#__codelineno-28-31"></a>            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">zone</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">last_recalled_at</span> <span class="o">&lt;</span> <span class="n">forget_threshold</span><span class="p">:</span>
<a id="__codelineno-28-32" name="__codelineno-28-32" href="#__codelineno-28-32"></a>                <span class="n">result</span><span class="o">.</span><span class="n">to_forget</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a id="__codelineno-28-33" name="__codelineno-28-33" href="#__codelineno-28-33"></a>            <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">last_recalled_at</span> <span class="o">&lt;</span> <span class="n">decay_threshold</span><span class="p">:</span>
<a id="__codelineno-28-34" name="__codelineno-28-34" href="#__codelineno-28-34"></a>                <span class="n">result</span><span class="o">.</span><span class="n">to_demote</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">zone</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">zone</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-28-35" name="__codelineno-28-35" href="#__codelineno-28-35"></a>
<a id="__codelineno-28-36" name="__codelineno-28-36" href="#__codelineno-28-36"></a>        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
<h4 id="244-new-events">2.4.4 New Events</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="c1"># event_bus.py EVENTS addition:</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="s2">&quot;on_adaptive_decay&quot;</span><span class="p">,</span>   <span class="c1"># (item, effective_days, actual_elapsed_days)</span>
</code></pre></div>
<hr />
<h3 id="f5-graph-analytics">F5: Graph Analytics</h3>
<h4 id="251-config">2.5.1 Config</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="c1"># config.py addition</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="nd">@dataclass</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">GraphAnalyticsConfig</span><span class="p">:</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>    <span class="n">community_min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># minimum nodes for a community</span>
</code></pre></div>
<p>Add to StellarConfig:
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="n">graph_analytics</span><span class="p">:</span> <span class="n">GraphAnalyticsConfig</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">GraphAnalyticsConfig</span><span class="p">)</span>
</code></pre></div></p>
<h4 id="252-graphanalyzer">2.5.2 GraphAnalyzer</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="c1"># graph_analyzer.py</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="nd">@dataclass</span>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">GraphStats</span><span class="p">:</span>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>    <span class="n">total_nodes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a>    <span class="n">total_edges</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a>    <span class="n">avg_degree</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a>    <span class="n">density</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a>    <span class="n">connected_components</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a>
<a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a><span class="nd">@dataclass</span>
<a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">CentralityResult</span><span class="p">:</span>
<a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a>    <span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a>    <span class="n">degree</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-32-17" name="__codelineno-32-17" href="#__codelineno-32-17"></a>    <span class="n">score</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># normalized degree centrality</span>
<a id="__codelineno-32-18" name="__codelineno-32-18" href="#__codelineno-32-18"></a>
<a id="__codelineno-32-19" name="__codelineno-32-19" href="#__codelineno-32-19"></a><span class="k">class</span><span class="w"> </span><span class="nc">GraphAnalyzer</span><span class="p">:</span>
<a id="__codelineno-32-20" name="__codelineno-32-20" href="#__codelineno-32-20"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyzes memory graph structure and patterns.&quot;&quot;&quot;</span>
<a id="__codelineno-32-21" name="__codelineno-32-21" href="#__codelineno-32-21"></a>
<a id="__codelineno-32-22" name="__codelineno-32-22" href="#__codelineno-32-22"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">GraphAnalyticsConfig</span><span class="p">):</span>
<a id="__codelineno-32-23" name="__codelineno-32-23" href="#__codelineno-32-23"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-32-24" name="__codelineno-32-24" href="#__codelineno-32-24"></a><span class="sd">        Args:</span>
<a id="__codelineno-32-25" name="__codelineno-32-25" href="#__codelineno-32-25"></a><span class="sd">            graph: MemoryGraph or PersistentMemoryGraph instance</span>
<a id="__codelineno-32-26" name="__codelineno-32-26" href="#__codelineno-32-26"></a><span class="sd">            config: GraphAnalyticsConfig</span>
<a id="__codelineno-32-27" name="__codelineno-32-27" href="#__codelineno-32-27"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-32-28" name="__codelineno-32-28" href="#__codelineno-32-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span> <span class="o">=</span> <span class="n">graph</span>
<a id="__codelineno-32-29" name="__codelineno-32-29" href="#__codelineno-32-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-32-30" name="__codelineno-32-30" href="#__codelineno-32-30"></a>
<a id="__codelineno-32-31" name="__codelineno-32-31" href="#__codelineno-32-31"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GraphStats</span><span class="p">:</span>
<a id="__codelineno-32-32" name="__codelineno-32-32" href="#__codelineno-32-32"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute graph-level statistics.&quot;&quot;&quot;</span>
<a id="__codelineno-32-33" name="__codelineno-32-33" href="#__codelineno-32-33"></a>        <span class="n">all_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_edges</span><span class="p">()</span>
<a id="__codelineno-32-34" name="__codelineno-32-34" href="#__codelineno-32-34"></a>        <span class="n">nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-32-35" name="__codelineno-32-35" href="#__codelineno-32-35"></a>        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">all_edges</span><span class="p">:</span>
<a id="__codelineno-32-36" name="__codelineno-32-36" href="#__codelineno-32-36"></a>            <span class="n">nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">source_id</span><span class="p">)</span>
<a id="__codelineno-32-37" name="__codelineno-32-37" href="#__codelineno-32-37"></a>            <span class="n">nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">target_id</span><span class="p">)</span>
<a id="__codelineno-32-38" name="__codelineno-32-38" href="#__codelineno-32-38"></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
<a id="__codelineno-32-39" name="__codelineno-32-39" href="#__codelineno-32-39"></a>        <span class="n">e</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_edges</span><span class="p">)</span>
<a id="__codelineno-32-40" name="__codelineno-32-40" href="#__codelineno-32-40"></a>        <span class="n">avg_deg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">e</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-32-41" name="__codelineno-32-41" href="#__codelineno-32-41"></a>        <span class="n">density</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">e</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-32-42" name="__codelineno-32-42" href="#__codelineno-32-42"></a>        <span class="n">components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_components</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">all_edges</span><span class="p">)</span>
<a id="__codelineno-32-43" name="__codelineno-32-43" href="#__codelineno-32-43"></a>        <span class="k">return</span> <span class="n">GraphStats</span><span class="p">(</span>
<a id="__codelineno-32-44" name="__codelineno-32-44" href="#__codelineno-32-44"></a>            <span class="n">total_nodes</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">total_edges</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
<a id="__codelineno-32-45" name="__codelineno-32-45" href="#__codelineno-32-45"></a>            <span class="n">avg_degree</span><span class="o">=</span><span class="n">avg_deg</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="n">density</span><span class="p">,</span>
<a id="__codelineno-32-46" name="__codelineno-32-46" href="#__codelineno-32-46"></a>            <span class="n">connected_components</span><span class="o">=</span><span class="n">components</span><span class="p">,</span>
<a id="__codelineno-32-47" name="__codelineno-32-47" href="#__codelineno-32-47"></a>        <span class="p">)</span>
<a id="__codelineno-32-48" name="__codelineno-32-48" href="#__codelineno-32-48"></a>
<a id="__codelineno-32-49" name="__codelineno-32-49" href="#__codelineno-32-49"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">centrality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">CentralityResult</span><span class="p">]:</span>
<a id="__codelineno-32-50" name="__codelineno-32-50" href="#__codelineno-32-50"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute degree centrality for all nodes.</span>
<a id="__codelineno-32-51" name="__codelineno-32-51" href="#__codelineno-32-51"></a><span class="sd">        Returns top-k nodes sorted by degree descending.&quot;&quot;&quot;</span>
<a id="__codelineno-32-52" name="__codelineno-32-52" href="#__codelineno-32-52"></a>        <span class="n">all_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_edges</span><span class="p">()</span>
<a id="__codelineno-32-53" name="__codelineno-32-53" href="#__codelineno-32-53"></a>        <span class="n">degree_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-32-54" name="__codelineno-32-54" href="#__codelineno-32-54"></a>        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">all_edges</span><span class="p">:</span>
<a id="__codelineno-32-55" name="__codelineno-32-55" href="#__codelineno-32-55"></a>            <span class="n">degree_map</span><span class="p">[</span><span class="n">edge</span><span class="o">.</span><span class="n">source_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-32-56" name="__codelineno-32-56" href="#__codelineno-32-56"></a>            <span class="n">degree_map</span><span class="p">[</span><span class="n">edge</span><span class="o">.</span><span class="n">target_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-32-57" name="__codelineno-32-57" href="#__codelineno-32-57"></a>        <span class="n">max_degree</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">degree_map</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">if</span> <span class="n">degree_map</span> <span class="k">else</span> <span class="mi">1</span>
<a id="__codelineno-32-58" name="__codelineno-32-58" href="#__codelineno-32-58"></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-32-59" name="__codelineno-32-59" href="#__codelineno-32-59"></a>            <span class="n">CentralityResult</span><span class="p">(</span>
<a id="__codelineno-32-60" name="__codelineno-32-60" href="#__codelineno-32-60"></a>                <span class="n">item_id</span><span class="o">=</span><span class="n">item_id</span><span class="p">,</span>
<a id="__codelineno-32-61" name="__codelineno-32-61" href="#__codelineno-32-61"></a>                <span class="n">degree</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span>
<a id="__codelineno-32-62" name="__codelineno-32-62" href="#__codelineno-32-62"></a>                <span class="n">score</span><span class="o">=</span><span class="n">deg</span> <span class="o">/</span> <span class="n">max_degree</span><span class="p">,</span>
<a id="__codelineno-32-63" name="__codelineno-32-63" href="#__codelineno-32-63"></a>            <span class="p">)</span>
<a id="__codelineno-32-64" name="__codelineno-32-64" href="#__codelineno-32-64"></a>            <span class="k">for</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">deg</span> <span class="ow">in</span> <span class="n">degree_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-32-65" name="__codelineno-32-65" href="#__codelineno-32-65"></a>        <span class="p">]</span>
<a id="__codelineno-32-66" name="__codelineno-32-66" href="#__codelineno-32-66"></a>        <span class="n">results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-32-67" name="__codelineno-32-67" href="#__codelineno-32-67"></a>        <span class="k">return</span> <span class="n">results</span><span class="p">[:</span><span class="n">top_k</span><span class="p">]</span>
<a id="__codelineno-32-68" name="__codelineno-32-68" href="#__codelineno-32-68"></a>
<a id="__codelineno-32-69" name="__codelineno-32-69" href="#__codelineno-32-69"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">communities</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<a id="__codelineno-32-70" name="__codelineno-32-70" href="#__codelineno-32-70"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Detect communities using connected components.</span>
<a id="__codelineno-32-71" name="__codelineno-32-71" href="#__codelineno-32-71"></a><span class="sd">        Returns list of communities (each is a list of item IDs).&quot;&quot;&quot;</span>
<a id="__codelineno-32-72" name="__codelineno-32-72" href="#__codelineno-32-72"></a>        <span class="n">all_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_edges</span><span class="p">()</span>
<a id="__codelineno-32-73" name="__codelineno-32-73" href="#__codelineno-32-73"></a>        <span class="n">nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-32-74" name="__codelineno-32-74" href="#__codelineno-32-74"></a>        <span class="n">adjacency</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
<a id="__codelineno-32-75" name="__codelineno-32-75" href="#__codelineno-32-75"></a>        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">all_edges</span><span class="p">:</span>
<a id="__codelineno-32-76" name="__codelineno-32-76" href="#__codelineno-32-76"></a>            <span class="n">nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">source_id</span><span class="p">)</span>
<a id="__codelineno-32-77" name="__codelineno-32-77" href="#__codelineno-32-77"></a>            <span class="n">nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">target_id</span><span class="p">)</span>
<a id="__codelineno-32-78" name="__codelineno-32-78" href="#__codelineno-32-78"></a>            <span class="n">adjacency</span><span class="p">[</span><span class="n">edge</span><span class="o">.</span><span class="n">source_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">target_id</span><span class="p">)</span>
<a id="__codelineno-32-79" name="__codelineno-32-79" href="#__codelineno-32-79"></a>            <span class="n">adjacency</span><span class="p">[</span><span class="n">edge</span><span class="o">.</span><span class="n">target_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">source_id</span><span class="p">)</span>
<a id="__codelineno-32-80" name="__codelineno-32-80" href="#__codelineno-32-80"></a>
<a id="__codelineno-32-81" name="__codelineno-32-81" href="#__codelineno-32-81"></a>        <span class="n">visited</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-32-82" name="__codelineno-32-82" href="#__codelineno-32-82"></a>        <span class="n">communities</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-32-83" name="__codelineno-32-83" href="#__codelineno-32-83"></a>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
<a id="__codelineno-32-84" name="__codelineno-32-84" href="#__codelineno-32-84"></a>            <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
<a id="__codelineno-32-85" name="__codelineno-32-85" href="#__codelineno-32-85"></a>                <span class="k">continue</span>
<a id="__codelineno-32-86" name="__codelineno-32-86" href="#__codelineno-32-86"></a>            <span class="n">component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bfs_component</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">adjacency</span><span class="p">,</span> <span class="n">visited</span><span class="p">)</span>
<a id="__codelineno-32-87" name="__codelineno-32-87" href="#__codelineno-32-87"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">component</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">community_min_size</span><span class="p">:</span>
<a id="__codelineno-32-88" name="__codelineno-32-88" href="#__codelineno-32-88"></a>                <span class="n">communities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">component</span><span class="p">))</span>
<a id="__codelineno-32-89" name="__codelineno-32-89" href="#__codelineno-32-89"></a>
<a id="__codelineno-32-90" name="__codelineno-32-90" href="#__codelineno-32-90"></a>        <span class="n">communities</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-32-91" name="__codelineno-32-91" href="#__codelineno-32-91"></a>        <span class="k">return</span> <span class="n">communities</span>
<a id="__codelineno-32-92" name="__codelineno-32-92" href="#__codelineno-32-92"></a>
<a id="__codelineno-32-93" name="__codelineno-32-93" href="#__codelineno-32-93"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-32-94" name="__codelineno-32-94" href="#__codelineno-32-94"></a>             <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-32-95" name="__codelineno-32-95" href="#__codelineno-32-95"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find shortest path between two memories using BFS.</span>
<a id="__codelineno-32-96" name="__codelineno-32-96" href="#__codelineno-32-96"></a><span class="sd">        Returns list of IDs from source to target, or None if no path.&quot;&quot;&quot;</span>
<a id="__codelineno-32-97" name="__codelineno-32-97" href="#__codelineno-32-97"></a>        <span class="n">all_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_edges</span><span class="p">()</span>
<a id="__codelineno-32-98" name="__codelineno-32-98" href="#__codelineno-32-98"></a>        <span class="n">adjacency</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
<a id="__codelineno-32-99" name="__codelineno-32-99" href="#__codelineno-32-99"></a>        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">all_edges</span><span class="p">:</span>
<a id="__codelineno-32-100" name="__codelineno-32-100" href="#__codelineno-32-100"></a>            <span class="n">adjacency</span><span class="p">[</span><span class="n">edge</span><span class="o">.</span><span class="n">source_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">target_id</span><span class="p">)</span>
<a id="__codelineno-32-101" name="__codelineno-32-101" href="#__codelineno-32-101"></a>            <span class="n">adjacency</span><span class="p">[</span><span class="n">edge</span><span class="o">.</span><span class="n">target_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">source_id</span><span class="p">)</span>
<a id="__codelineno-32-102" name="__codelineno-32-102" href="#__codelineno-32-102"></a>
<a id="__codelineno-32-103" name="__codelineno-32-103" href="#__codelineno-32-103"></a>        <span class="c1"># BFS with parent tracking</span>
<a id="__codelineno-32-104" name="__codelineno-32-104" href="#__codelineno-32-104"></a>        <span class="n">visited</span> <span class="o">=</span> <span class="p">{</span><span class="n">source_id</span><span class="p">}</span>
<a id="__codelineno-32-105" name="__codelineno-32-105" href="#__codelineno-32-105"></a>        <span class="n">parent</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">source_id</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
<a id="__codelineno-32-106" name="__codelineno-32-106" href="#__codelineno-32-106"></a>        <span class="n">queue</span> <span class="o">=</span> <span class="p">[(</span><span class="n">source_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
<a id="__codelineno-32-107" name="__codelineno-32-107" href="#__codelineno-32-107"></a>        <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
<a id="__codelineno-32-108" name="__codelineno-32-108" href="#__codelineno-32-108"></a>            <span class="n">current</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-32-109" name="__codelineno-32-109" href="#__codelineno-32-109"></a>            <span class="k">if</span> <span class="n">current</span> <span class="o">==</span> <span class="n">target_id</span><span class="p">:</span>
<a id="__codelineno-32-110" name="__codelineno-32-110" href="#__codelineno-32-110"></a>                <span class="c1"># Reconstruct path</span>
<a id="__codelineno-32-111" name="__codelineno-32-111" href="#__codelineno-32-111"></a>                <span class="n">path</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-32-112" name="__codelineno-32-112" href="#__codelineno-32-112"></a>                <span class="n">node</span> <span class="o">=</span> <span class="n">target_id</span>
<a id="__codelineno-32-113" name="__codelineno-32-113" href="#__codelineno-32-113"></a>                <span class="k">while</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-32-114" name="__codelineno-32-114" href="#__codelineno-32-114"></a>                    <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a id="__codelineno-32-115" name="__codelineno-32-115" href="#__codelineno-32-115"></a>                    <span class="n">node</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
<a id="__codelineno-32-116" name="__codelineno-32-116" href="#__codelineno-32-116"></a>                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
<a id="__codelineno-32-117" name="__codelineno-32-117" href="#__codelineno-32-117"></a>            <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">max_depth</span><span class="p">:</span>
<a id="__codelineno-32-118" name="__codelineno-32-118" href="#__codelineno-32-118"></a>                <span class="k">continue</span>
<a id="__codelineno-32-119" name="__codelineno-32-119" href="#__codelineno-32-119"></a>            <span class="k">for</span> <span class="n">neighbor</span> <span class="ow">in</span> <span class="n">adjacency</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="nb">set</span><span class="p">()):</span>
<a id="__codelineno-32-120" name="__codelineno-32-120" href="#__codelineno-32-120"></a>                <span class="k">if</span> <span class="n">neighbor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
<a id="__codelineno-32-121" name="__codelineno-32-121" href="#__codelineno-32-121"></a>                    <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">neighbor</span><span class="p">)</span>
<a id="__codelineno-32-122" name="__codelineno-32-122" href="#__codelineno-32-122"></a>                    <span class="n">parent</span><span class="p">[</span><span class="n">neighbor</span><span class="p">]</span> <span class="o">=</span> <span class="n">current</span>
<a id="__codelineno-32-123" name="__codelineno-32-123" href="#__codelineno-32-123"></a>                    <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">neighbor</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-32-124" name="__codelineno-32-124" href="#__codelineno-32-124"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-32-125" name="__codelineno-32-125" href="#__codelineno-32-125"></a>
<a id="__codelineno-32-126" name="__codelineno-32-126" href="#__codelineno-32-126"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memory_getter</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-32-127" name="__codelineno-32-127" href="#__codelineno-32-127"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Export graph in DOT format for Graphviz visualization.</span>
<a id="__codelineno-32-128" name="__codelineno-32-128" href="#__codelineno-32-128"></a>
<a id="__codelineno-32-129" name="__codelineno-32-129" href="#__codelineno-32-129"></a><span class="sd">        Args:</span>
<a id="__codelineno-32-130" name="__codelineno-32-130" href="#__codelineno-32-130"></a><span class="sd">            memory_getter: Optional callable(id) -&gt; MemoryItem for labels</span>
<a id="__codelineno-32-131" name="__codelineno-32-131" href="#__codelineno-32-131"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-32-132" name="__codelineno-32-132" href="#__codelineno-32-132"></a>        <span class="n">all_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_edges</span><span class="p">()</span>
<a id="__codelineno-32-133" name="__codelineno-32-133" href="#__codelineno-32-133"></a>        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;digraph StellarMemory {&quot;</span><span class="p">]</span>
<a id="__codelineno-32-134" name="__codelineno-32-134" href="#__codelineno-32-134"></a>        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  rankdir=LR;&#39;</span><span class="p">)</span>
<a id="__codelineno-32-135" name="__codelineno-32-135" href="#__codelineno-32-135"></a>        <span class="n">nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-32-136" name="__codelineno-32-136" href="#__codelineno-32-136"></a>        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">all_edges</span><span class="p">:</span>
<a id="__codelineno-32-137" name="__codelineno-32-137" href="#__codelineno-32-137"></a>            <span class="n">nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">source_id</span><span class="p">)</span>
<a id="__codelineno-32-138" name="__codelineno-32-138" href="#__codelineno-32-138"></a>            <span class="n">nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">target_id</span><span class="p">)</span>
<a id="__codelineno-32-139" name="__codelineno-32-139" href="#__codelineno-32-139"></a>        <span class="k">for</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">nodes</span><span class="p">):</span>
<a id="__codelineno-32-140" name="__codelineno-32-140" href="#__codelineno-32-140"></a>            <span class="n">label</span> <span class="o">=</span> <span class="n">node_id</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>
<a id="__codelineno-32-141" name="__codelineno-32-141" href="#__codelineno-32-141"></a>            <span class="k">if</span> <span class="n">memory_getter</span><span class="p">:</span>
<a id="__codelineno-32-142" name="__codelineno-32-142" href="#__codelineno-32-142"></a>                <span class="n">item</span> <span class="o">=</span> <span class="n">memory_getter</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
<a id="__codelineno-32-143" name="__codelineno-32-143" href="#__codelineno-32-143"></a>                <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
<a id="__codelineno-32-144" name="__codelineno-32-144" href="#__codelineno-32-144"></a>                    <span class="n">label</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
<a id="__codelineno-32-145" name="__codelineno-32-145" href="#__codelineno-32-145"></a>            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  &quot;</span><span class="si">{</span><span class="n">node_id</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot; [label=&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&quot;];&#39;</span><span class="p">)</span>
<a id="__codelineno-32-146" name="__codelineno-32-146" href="#__codelineno-32-146"></a>        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">all_edges</span><span class="p">:</span>
<a id="__codelineno-32-147" name="__codelineno-32-147" href="#__codelineno-32-147"></a>            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-32-148" name="__codelineno-32-148" href="#__codelineno-32-148"></a>                <span class="sa">f</span><span class="s1">&#39;  &quot;</span><span class="si">{</span><span class="n">edge</span><span class="o">.</span><span class="n">source_id</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot; -&gt; &quot;</span><span class="si">{</span><span class="n">edge</span><span class="o">.</span><span class="n">target_id</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot; &#39;</span>
<a id="__codelineno-32-149" name="__codelineno-32-149" href="#__codelineno-32-149"></a>                <span class="sa">f</span><span class="s1">&#39;[label=&quot;</span><span class="si">{</span><span class="n">edge</span><span class="o">.</span><span class="n">edge_type</span><span class="si">}</span><span class="s1">&quot;];&#39;</span>
<a id="__codelineno-32-150" name="__codelineno-32-150" href="#__codelineno-32-150"></a>            <span class="p">)</span>
<a id="__codelineno-32-151" name="__codelineno-32-151" href="#__codelineno-32-151"></a>        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">)</span>
<a id="__codelineno-32-152" name="__codelineno-32-152" href="#__codelineno-32-152"></a>        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
<a id="__codelineno-32-153" name="__codelineno-32-153" href="#__codelineno-32-153"></a>
<a id="__codelineno-32-154" name="__codelineno-32-154" href="#__codelineno-32-154"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_graphml</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-32-155" name="__codelineno-32-155" href="#__codelineno-32-155"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Export graph in GraphML format.&quot;&quot;&quot;</span>
<a id="__codelineno-32-156" name="__codelineno-32-156" href="#__codelineno-32-156"></a>        <span class="n">all_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_edges</span><span class="p">()</span>
<a id="__codelineno-32-157" name="__codelineno-32-157" href="#__codelineno-32-157"></a>        <span class="n">nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-32-158" name="__codelineno-32-158" href="#__codelineno-32-158"></a>        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">all_edges</span><span class="p">:</span>
<a id="__codelineno-32-159" name="__codelineno-32-159" href="#__codelineno-32-159"></a>            <span class="n">nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">source_id</span><span class="p">)</span>
<a id="__codelineno-32-160" name="__codelineno-32-160" href="#__codelineno-32-160"></a>            <span class="n">nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">target_id</span><span class="p">)</span>
<a id="__codelineno-32-161" name="__codelineno-32-161" href="#__codelineno-32-161"></a>        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&#39;</span><span class="p">]</span>
<a id="__codelineno-32-162" name="__codelineno-32-162" href="#__codelineno-32-162"></a>        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;graphml xmlns=&quot;http://graphml.graphstruct.org/graphml&quot;&gt;&#39;</span><span class="p">)</span>
<a id="__codelineno-32-163" name="__codelineno-32-163" href="#__codelineno-32-163"></a>        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  &lt;graph id=&quot;stellar-memory&quot; edgedefault=&quot;directed&quot;&gt;&#39;</span><span class="p">)</span>
<a id="__codelineno-32-164" name="__codelineno-32-164" href="#__codelineno-32-164"></a>        <span class="k">for</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">nodes</span><span class="p">):</span>
<a id="__codelineno-32-165" name="__codelineno-32-165" href="#__codelineno-32-165"></a>            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    &lt;node id=&quot;</span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="s1">&quot;/&gt;&#39;</span><span class="p">)</span>
<a id="__codelineno-32-166" name="__codelineno-32-166" href="#__codelineno-32-166"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">edge</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_edges</span><span class="p">):</span>
<a id="__codelineno-32-167" name="__codelineno-32-167" href="#__codelineno-32-167"></a>            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-32-168" name="__codelineno-32-168" href="#__codelineno-32-168"></a>                <span class="sa">f</span><span class="s1">&#39;    &lt;edge id=&quot;e</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&quot; source=&quot;</span><span class="si">{</span><span class="n">edge</span><span class="o">.</span><span class="n">source_id</span><span class="si">}</span><span class="s1">&quot; &#39;</span>
<a id="__codelineno-32-169" name="__codelineno-32-169" href="#__codelineno-32-169"></a>                <span class="sa">f</span><span class="s1">&#39;target=&quot;</span><span class="si">{</span><span class="n">edge</span><span class="o">.</span><span class="n">target_id</span><span class="si">}</span><span class="s1">&quot;/&gt;&#39;</span>
<a id="__codelineno-32-170" name="__codelineno-32-170" href="#__codelineno-32-170"></a>            <span class="p">)</span>
<a id="__codelineno-32-171" name="__codelineno-32-171" href="#__codelineno-32-171"></a>        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  &lt;/graph&gt;&#39;</span><span class="p">)</span>
<a id="__codelineno-32-172" name="__codelineno-32-172" href="#__codelineno-32-172"></a>        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;/graphml&gt;&#39;</span><span class="p">)</span>
<a id="__codelineno-32-173" name="__codelineno-32-173" href="#__codelineno-32-173"></a>        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
<a id="__codelineno-32-174" name="__codelineno-32-174" href="#__codelineno-32-174"></a>
<a id="__codelineno-32-175" name="__codelineno-32-175" href="#__codelineno-32-175"></a>    <span class="c1"># --- Internal helpers ---</span>
<a id="__codelineno-32-176" name="__codelineno-32-176" href="#__codelineno-32-176"></a>
<a id="__codelineno-32-177" name="__codelineno-32-177" href="#__codelineno-32-177"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_all_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-32-178" name="__codelineno-32-178" href="#__codelineno-32-178"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all edges from graph (works with both MemoryGraph and PersistentMemoryGraph).&quot;&quot;&quot;</span>
<a id="__codelineno-32-179" name="__codelineno-32-179" href="#__codelineno-32-179"></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="p">,</span> <span class="s1">&#39;_edges&#39;</span><span class="p">):</span>
<a id="__codelineno-32-180" name="__codelineno-32-180" href="#__codelineno-32-180"></a>            <span class="c1"># In-memory MemoryGraph</span>
<a id="__codelineno-32-181" name="__codelineno-32-181" href="#__codelineno-32-181"></a>            <span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-32-182" name="__codelineno-32-182" href="#__codelineno-32-182"></a>            <span class="k">for</span> <span class="n">edge_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">_edges</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-32-183" name="__codelineno-32-183" href="#__codelineno-32-183"></a>                <span class="n">edges</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">edge_list</span><span class="p">)</span>
<a id="__codelineno-32-184" name="__codelineno-32-184" href="#__codelineno-32-184"></a>            <span class="k">return</span> <span class="n">edges</span>
<a id="__codelineno-32-185" name="__codelineno-32-185" href="#__codelineno-32-185"></a>        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="p">,</span> <span class="s1">&#39;_get_conn&#39;</span><span class="p">):</span>
<a id="__codelineno-32-186" name="__codelineno-32-186" href="#__codelineno-32-186"></a>            <span class="c1"># PersistentMemoryGraph</span>
<a id="__codelineno-32-187" name="__codelineno-32-187" href="#__codelineno-32-187"></a>            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">_get_conn</span><span class="p">()</span>
<a id="__codelineno-32-188" name="__codelineno-32-188" href="#__codelineno-32-188"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">stellar_memory.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">MemoryEdge</span>
<a id="__codelineno-32-189" name="__codelineno-32-189" href="#__codelineno-32-189"></a>            <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-32-190" name="__codelineno-32-190" href="#__codelineno-32-190"></a>                <span class="s2">&quot;SELECT source_id, target_id, edge_type, weight, created_at FROM edges&quot;</span>
<a id="__codelineno-32-191" name="__codelineno-32-191" href="#__codelineno-32-191"></a>            <span class="p">)</span>
<a id="__codelineno-32-192" name="__codelineno-32-192" href="#__codelineno-32-192"></a>            <span class="k">return</span> <span class="p">[</span>
<a id="__codelineno-32-193" name="__codelineno-32-193" href="#__codelineno-32-193"></a>                <span class="n">MemoryEdge</span><span class="p">(</span><span class="n">source_id</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">target_id</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">edge_type</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
<a id="__codelineno-32-194" name="__codelineno-32-194" href="#__codelineno-32-194"></a>                           <span class="n">weight</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">created_at</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
<a id="__codelineno-32-195" name="__codelineno-32-195" href="#__codelineno-32-195"></a>                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<a id="__codelineno-32-196" name="__codelineno-32-196" href="#__codelineno-32-196"></a>            <span class="p">]</span>
<a id="__codelineno-32-197" name="__codelineno-32-197" href="#__codelineno-32-197"></a>        <span class="k">return</span> <span class="p">[]</span>
<a id="__codelineno-32-198" name="__codelineno-32-198" href="#__codelineno-32-198"></a>
<a id="__codelineno-32-199" name="__codelineno-32-199" href="#__codelineno-32-199"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_count_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-32-200" name="__codelineno-32-200" href="#__codelineno-32-200"></a>        <span class="n">adjacency</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
<a id="__codelineno-32-201" name="__codelineno-32-201" href="#__codelineno-32-201"></a>        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
<a id="__codelineno-32-202" name="__codelineno-32-202" href="#__codelineno-32-202"></a>            <span class="n">adjacency</span><span class="p">[</span><span class="n">edge</span><span class="o">.</span><span class="n">source_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">target_id</span><span class="p">)</span>
<a id="__codelineno-32-203" name="__codelineno-32-203" href="#__codelineno-32-203"></a>            <span class="n">adjacency</span><span class="p">[</span><span class="n">edge</span><span class="o">.</span><span class="n">target_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">source_id</span><span class="p">)</span>
<a id="__codelineno-32-204" name="__codelineno-32-204" href="#__codelineno-32-204"></a>        <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-32-205" name="__codelineno-32-205" href="#__codelineno-32-205"></a>        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-32-206" name="__codelineno-32-206" href="#__codelineno-32-206"></a>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
<a id="__codelineno-32-207" name="__codelineno-32-207" href="#__codelineno-32-207"></a>            <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
<a id="__codelineno-32-208" name="__codelineno-32-208" href="#__codelineno-32-208"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_bfs_component</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">adjacency</span><span class="p">,</span> <span class="n">visited</span><span class="p">)</span>
<a id="__codelineno-32-209" name="__codelineno-32-209" href="#__codelineno-32-209"></a>                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-32-210" name="__codelineno-32-210" href="#__codelineno-32-210"></a>        <span class="k">return</span> <span class="n">count</span>
<a id="__codelineno-32-211" name="__codelineno-32-211" href="#__codelineno-32-211"></a>
<a id="__codelineno-32-212" name="__codelineno-32-212" href="#__codelineno-32-212"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_bfs_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">adjacency</span><span class="p">,</span> <span class="n">visited</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-32-213" name="__codelineno-32-213" href="#__codelineno-32-213"></a>        <span class="n">component</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-32-214" name="__codelineno-32-214" href="#__codelineno-32-214"></a>        <span class="n">queue</span> <span class="o">=</span> <span class="p">[</span><span class="n">start</span><span class="p">]</span>
<a id="__codelineno-32-215" name="__codelineno-32-215" href="#__codelineno-32-215"></a>        <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
<a id="__codelineno-32-216" name="__codelineno-32-216" href="#__codelineno-32-216"></a>            <span class="n">node</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-32-217" name="__codelineno-32-217" href="#__codelineno-32-217"></a>            <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
<a id="__codelineno-32-218" name="__codelineno-32-218" href="#__codelineno-32-218"></a>                <span class="k">continue</span>
<a id="__codelineno-32-219" name="__codelineno-32-219" href="#__codelineno-32-219"></a>            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a id="__codelineno-32-220" name="__codelineno-32-220" href="#__codelineno-32-220"></a>            <span class="n">component</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a id="__codelineno-32-221" name="__codelineno-32-221" href="#__codelineno-32-221"></a>            <span class="k">for</span> <span class="n">neighbor</span> <span class="ow">in</span> <span class="n">adjacency</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">set</span><span class="p">()):</span>
<a id="__codelineno-32-222" name="__codelineno-32-222" href="#__codelineno-32-222"></a>                <span class="k">if</span> <span class="n">neighbor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
<a id="__codelineno-32-223" name="__codelineno-32-223" href="#__codelineno-32-223"></a>                    <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neighbor</span><span class="p">)</span>
<a id="__codelineno-32-224" name="__codelineno-32-224" href="#__codelineno-32-224"></a>        <span class="k">return</span> <span class="n">component</span>
</code></pre></div>
<h4 id="253-stellarmemory-integration">2.5.3 StellarMemory Integration</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="c1"># stellar.py additions</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>    <span class="c1"># ... existing init ...</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>    <span class="c1"># Graph Analyzer</span>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_analyzer</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">graph_analytics</span><span class="o">.</span><span class="n">enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">stellar_memory.graph_analyzer</span><span class="w"> </span><span class="kn">import</span> <span class="n">GraphAnalyzer</span>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_analyzer</span> <span class="o">=</span> <span class="n">GraphAnalyzer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">graph_analytics</span><span class="p">)</span>
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a>
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="nd">@property</span>
<a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a><span class="k">def</span><span class="w"> </span><span class="nf">analyzer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GraphAnalyzer</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyzer</span>
<a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a>
<a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a><span class="k">def</span><span class="w"> </span><span class="nf">graph_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GraphStats</span><span class="p">:</span>
<a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyzer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Graph analytics not enabled&quot;</span><span class="p">)</span>
<a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyzer</span><span class="o">.</span><span class="n">stats</span><span class="p">()</span>
<a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a>
<a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a><span class="k">def</span><span class="w"> </span><span class="nf">graph_communities</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyzer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Graph analytics not enabled&quot;</span><span class="p">)</span>
<a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyzer</span><span class="o">.</span><span class="n">communities</span><span class="p">()</span>
<a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a>
<a id="__codelineno-33-25" name="__codelineno-33-25" href="#__codelineno-33-25"></a><span class="k">def</span><span class="w"> </span><span class="nf">graph_centrality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">CentralityResult</span><span class="p">]:</span>
<a id="__codelineno-33-26" name="__codelineno-33-26" href="#__codelineno-33-26"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyzer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-33-27" name="__codelineno-33-27" href="#__codelineno-33-27"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Graph analytics not enabled&quot;</span><span class="p">)</span>
<a id="__codelineno-33-28" name="__codelineno-33-28" href="#__codelineno-33-28"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyzer</span><span class="o">.</span><span class="n">centrality</span><span class="p">(</span><span class="n">top_k</span><span class="p">)</span>
<a id="__codelineno-33-29" name="__codelineno-33-29" href="#__codelineno-33-29"></a>
<a id="__codelineno-33-30" name="__codelineno-33-30" href="#__codelineno-33-30"></a><span class="k">def</span><span class="w"> </span><span class="nf">graph_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-33-31" name="__codelineno-33-31" href="#__codelineno-33-31"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyzer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-33-32" name="__codelineno-33-32" href="#__codelineno-33-32"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Graph analytics not enabled&quot;</span><span class="p">)</span>
<a id="__codelineno-33-33" name="__codelineno-33-33" href="#__codelineno-33-33"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyzer</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">source_id</span><span class="p">,</span> <span class="n">target_id</span><span class="p">)</span>
</code></pre></div>
<h4 id="254-mcp-tool">2.5.4 MCP Tool</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="c1"># mcp_server.py addition</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="nd">@mcp</span><span class="o">.</span><span class="n">tool</span><span class="p">()</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">memory_graph_analyze</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">source_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>                         <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyze the memory graph structure.</span>
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="sd">    Args:</span>
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="sd">        action: One of &quot;stats&quot;, &quot;communities&quot;, &quot;centrality&quot;, &quot;path&quot;</span>
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="sd">        source_id: Required for &quot;path&quot; action - start node</span>
<a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a><span class="sd">        target_id: Required for &quot;path&quot; action - end node</span>
<a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a><span class="sd">        top_k: For &quot;centrality&quot; - number of top nodes to return</span>
<a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a>    <span class="k">if</span> <span class="n">memory</span><span class="o">.</span><span class="n">_analyzer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Graph analytics not enabled&quot;</span><span class="p">})</span>
<a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a>
<a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a>    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;stats&quot;</span><span class="p">:</span>
<a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">_analyzer</span><span class="o">.</span><span class="n">stats</span><span class="p">()</span>
<a id="__codelineno-34-19" name="__codelineno-34-19" href="#__codelineno-34-19"></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
<a id="__codelineno-34-20" name="__codelineno-34-20" href="#__codelineno-34-20"></a>            <span class="s2">&quot;total_nodes&quot;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">total_nodes</span><span class="p">,</span>
<a id="__codelineno-34-21" name="__codelineno-34-21" href="#__codelineno-34-21"></a>            <span class="s2">&quot;total_edges&quot;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">total_edges</span><span class="p">,</span>
<a id="__codelineno-34-22" name="__codelineno-34-22" href="#__codelineno-34-22"></a>            <span class="s2">&quot;avg_degree&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">avg_degree</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-34-23" name="__codelineno-34-23" href="#__codelineno-34-23"></a>            <span class="s2">&quot;density&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">density</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<a id="__codelineno-34-24" name="__codelineno-34-24" href="#__codelineno-34-24"></a>            <span class="s2">&quot;connected_components&quot;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">connected_components</span><span class="p">,</span>
<a id="__codelineno-34-25" name="__codelineno-34-25" href="#__codelineno-34-25"></a>        <span class="p">})</span>
<a id="__codelineno-34-26" name="__codelineno-34-26" href="#__codelineno-34-26"></a>    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;communities&quot;</span><span class="p">:</span>
<a id="__codelineno-34-27" name="__codelineno-34-27" href="#__codelineno-34-27"></a>        <span class="n">comms</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">_analyzer</span><span class="o">.</span><span class="n">communities</span><span class="p">()</span>
<a id="__codelineno-34-28" name="__codelineno-34-28" href="#__codelineno-34-28"></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
<a id="__codelineno-34-29" name="__codelineno-34-29" href="#__codelineno-34-29"></a>            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">comms</span><span class="p">),</span>
<a id="__codelineno-34-30" name="__codelineno-34-30" href="#__codelineno-34-30"></a>            <span class="s2">&quot;communities&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="s2">&quot;members&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">[:</span><span class="mi">5</span><span class="p">]}</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comms</span><span class="p">],</span>
<a id="__codelineno-34-31" name="__codelineno-34-31" href="#__codelineno-34-31"></a>        <span class="p">})</span>
<a id="__codelineno-34-32" name="__codelineno-34-32" href="#__codelineno-34-32"></a>    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;centrality&quot;</span><span class="p">:</span>
<a id="__codelineno-34-33" name="__codelineno-34-33" href="#__codelineno-34-33"></a>        <span class="n">results</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">_analyzer</span><span class="o">.</span><span class="n">centrality</span><span class="p">(</span><span class="n">top_k</span><span class="p">)</span>
<a id="__codelineno-34-34" name="__codelineno-34-34" href="#__codelineno-34-34"></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([{</span>
<a id="__codelineno-34-35" name="__codelineno-34-35" href="#__codelineno-34-35"></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">item_id</span><span class="p">[:</span><span class="mi">8</span><span class="p">],</span>
<a id="__codelineno-34-36" name="__codelineno-34-36" href="#__codelineno-34-36"></a>            <span class="s2">&quot;degree&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
<a id="__codelineno-34-37" name="__codelineno-34-37" href="#__codelineno-34-37"></a>            <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
<a id="__codelineno-34-38" name="__codelineno-34-38" href="#__codelineno-34-38"></a>        <span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
<a id="__codelineno-34-39" name="__codelineno-34-39" href="#__codelineno-34-39"></a>    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span>
<a id="__codelineno-34-40" name="__codelineno-34-40" href="#__codelineno-34-40"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">source_id</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">target_id</span><span class="p">:</span>
<a id="__codelineno-34-41" name="__codelineno-34-41" href="#__codelineno-34-41"></a>            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;source_id and target_id required&quot;</span><span class="p">})</span>
<a id="__codelineno-34-42" name="__codelineno-34-42" href="#__codelineno-34-42"></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">_analyzer</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">source_id</span><span class="p">,</span> <span class="n">target_id</span><span class="p">)</span>
<a id="__codelineno-34-43" name="__codelineno-34-43" href="#__codelineno-34-43"></a>        <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-34-44" name="__codelineno-34-44" href="#__codelineno-34-44"></a>            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;No path found&quot;</span><span class="p">})</span>
<a id="__codelineno-34-45" name="__codelineno-34-45" href="#__codelineno-34-45"></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span> <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">})</span>
<a id="__codelineno-34-46" name="__codelineno-34-46" href="#__codelineno-34-46"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-34-47" name="__codelineno-34-47" href="#__codelineno-34-47"></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Unknown action: </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>
</code></pre></div>
<h4 id="255-cli-commands">2.5.5 CLI Commands</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="c1"># cli.py additions</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="c1"># graph subparser with sub-subparsers</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="n">p_graph</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;graph&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Graph analysis commands&quot;</span><span class="p">)</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="n">graph_sub</span> <span class="o">=</span> <span class="n">p_graph</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">dest</span><span class="o">=</span><span class="s2">&quot;graph_command&quot;</span><span class="p">)</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="n">graph_sub</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;stats&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Graph statistics&quot;</span><span class="p">)</span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="n">p_gc</span> <span class="o">=</span> <span class="n">graph_sub</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;communities&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Detect communities&quot;</span><span class="p">)</span>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a>
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="n">p_gcent</span> <span class="o">=</span> <span class="n">graph_sub</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;centrality&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Node centrality&quot;</span><span class="p">)</span>
<a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a><span class="n">p_gcent</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--top&quot;</span><span class="p">,</span> <span class="s2">&quot;-k&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a>
<a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a><span class="n">p_gpath</span> <span class="o">=</span> <span class="n">graph_sub</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Find path between memories&quot;</span><span class="p">)</span>
<a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a><span class="n">p_gpath</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Source memory ID&quot;</span><span class="p">)</span>
<a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a><span class="n">p_gpath</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Target memory ID&quot;</span><span class="p">)</span>
<a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a>
<a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a><span class="n">p_gexport</span> <span class="o">=</span> <span class="n">graph_sub</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;export&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Export graph&quot;</span><span class="p">)</span>
<a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a><span class="n">p_gexport</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--format&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;dot&quot;</span><span class="p">,</span> <span class="s2">&quot;graphml&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;dot&quot;</span><span class="p">)</span>
<a id="__codelineno-35-20" name="__codelineno-35-20" href="#__codelineno-35-20"></a><span class="n">p_gexport</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--output&quot;</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
<a id="__codelineno-35-21" name="__codelineno-35-21" href="#__codelineno-35-21"></a>
<a id="__codelineno-35-22" name="__codelineno-35-22" href="#__codelineno-35-22"></a><span class="c1"># handler</span>
<a id="__codelineno-35-23" name="__codelineno-35-23" href="#__codelineno-35-23"></a><span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;graph&quot;</span><span class="p">:</span>
<a id="__codelineno-35-24" name="__codelineno-35-24" href="#__codelineno-35-24"></a>    <span class="k">if</span> <span class="n">memory</span><span class="o">.</span><span class="n">_analyzer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-35-25" name="__codelineno-35-25" href="#__codelineno-35-25"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Graph analytics not enabled&quot;</span><span class="p">)</span>
<a id="__codelineno-35-26" name="__codelineno-35-26" href="#__codelineno-35-26"></a>        <span class="k">return</span>
<a id="__codelineno-35-27" name="__codelineno-35-27" href="#__codelineno-35-27"></a>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">graph_command</span> <span class="o">==</span> <span class="s2">&quot;stats&quot;</span><span class="p">:</span>
<a id="__codelineno-35-28" name="__codelineno-35-28" href="#__codelineno-35-28"></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">_analyzer</span><span class="o">.</span><span class="n">stats</span><span class="p">()</span>
<a id="__codelineno-35-29" name="__codelineno-35-29" href="#__codelineno-35-29"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nodes: </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">total_nodes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-35-30" name="__codelineno-35-30" href="#__codelineno-35-30"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Edges: </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">total_edges</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-35-31" name="__codelineno-35-31" href="#__codelineno-35-31"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Avg degree: </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">avg_degree</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-35-32" name="__codelineno-35-32" href="#__codelineno-35-32"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Density: </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">density</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-35-33" name="__codelineno-35-33" href="#__codelineno-35-33"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Components: </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">connected_components</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-35-34" name="__codelineno-35-34" href="#__codelineno-35-34"></a>    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">graph_command</span> <span class="o">==</span> <span class="s2">&quot;communities&quot;</span><span class="p">:</span>
<a id="__codelineno-35-35" name="__codelineno-35-35" href="#__codelineno-35-35"></a>        <span class="n">comms</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">_analyzer</span><span class="o">.</span><span class="n">communities</span><span class="p">()</span>
<a id="__codelineno-35-36" name="__codelineno-35-36" href="#__codelineno-35-36"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Communities found: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comms</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-35-37" name="__codelineno-35-37" href="#__codelineno-35-37"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">comms</span><span class="p">):</span>
<a id="__codelineno-35-38" name="__codelineno-35-38" href="#__codelineno-35-38"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  #</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="si">}</span><span class="s2"> members - </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">id</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nb">id</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">c</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-35-39" name="__codelineno-35-39" href="#__codelineno-35-39"></a>    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">graph_command</span> <span class="o">==</span> <span class="s2">&quot;centrality&quot;</span><span class="p">:</span>
<a id="__codelineno-35-40" name="__codelineno-35-40" href="#__codelineno-35-40"></a>        <span class="n">results</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">_analyzer</span><span class="o">.</span><span class="n">centrality</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">top</span><span class="p">)</span>
<a id="__codelineno-35-41" name="__codelineno-35-41" href="#__codelineno-35-41"></a>        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
<a id="__codelineno-35-42" name="__codelineno-35-42" href="#__codelineno-35-42"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [</span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">item_id</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">] degree=</span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">degree</span><span class="si">}</span><span class="s2"> score=</span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">score</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-35-43" name="__codelineno-35-43" href="#__codelineno-35-43"></a>    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">graph_command</span> <span class="o">==</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span>
<a id="__codelineno-35-44" name="__codelineno-35-44" href="#__codelineno-35-44"></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">_analyzer</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
<a id="__codelineno-35-45" name="__codelineno-35-45" href="#__codelineno-35-45"></a>        <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-35-46" name="__codelineno-35-46" href="#__codelineno-35-46"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No path found&quot;</span><span class="p">)</span>
<a id="__codelineno-35-47" name="__codelineno-35-47" href="#__codelineno-35-47"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-35-48" name="__codelineno-35-48" href="#__codelineno-35-48"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Path (length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="s1">&#39; -&gt; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">id</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nb">id</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-35-49" name="__codelineno-35-49" href="#__codelineno-35-49"></a>    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">graph_command</span> <span class="o">==</span> <span class="s2">&quot;export&quot;</span><span class="p">:</span>
<a id="__codelineno-35-50" name="__codelineno-35-50" href="#__codelineno-35-50"></a>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s2">&quot;dot&quot;</span><span class="p">:</span>
<a id="__codelineno-35-51" name="__codelineno-35-51" href="#__codelineno-35-51"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">_analyzer</span><span class="o">.</span><span class="n">export_dot</span><span class="p">(</span><span class="n">memory_getter</span><span class="o">=</span><span class="n">memory</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
<a id="__codelineno-35-52" name="__codelineno-35-52" href="#__codelineno-35-52"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-35-53" name="__codelineno-35-53" href="#__codelineno-35-53"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">_analyzer</span><span class="o">.</span><span class="n">export_graphml</span><span class="p">()</span>
<a id="__codelineno-35-54" name="__codelineno-35-54" href="#__codelineno-35-54"></a>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
<a id="__codelineno-35-55" name="__codelineno-35-55" href="#__codelineno-35-55"></a>            <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-35-56" name="__codelineno-35-56" href="#__codelineno-35-56"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-35-57" name="__codelineno-35-57" href="#__codelineno-35-57"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-35-58" name="__codelineno-35-58" href="#__codelineno-35-58"></a>                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-35-59" name="__codelineno-35-59" href="#__codelineno-35-59"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exported to </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="3-models-newmodified">3. Models (New/Modified)</h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="c1"># models.py additions</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="nd">@dataclass</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">SummarizationResult</span><span class="p">:</span>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>    <span class="n">original_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>    <span class="n">summary_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>    <span class="n">summary_text</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a>    <span class="n">original_length</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>    <span class="n">summary_length</span><span class="p">:</span> <span class="nb">int</span>
</code></pre></div>
<hr />
<h2 id="4-initpy-exports-v060">4. <strong>init</strong>.py Exports (v0.6.0)</h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="c1"># New exports for P5</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">stellar_memory.config</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>    <span class="o">...</span><span class="p">,</span>  <span class="c1"># existing</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>    <span class="n">VectorIndexConfig</span><span class="p">,</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>    <span class="n">SummarizationConfig</span><span class="p">,</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>    <span class="n">AdaptiveDecayConfig</span><span class="p">,</span>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>    <span class="n">GraphAnalyticsConfig</span><span class="p">,</span>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="p">)</span>
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">stellar_memory.models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a>    <span class="o">...</span><span class="p">,</span>  <span class="c1"># existing</span>
<a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a>    <span class="n">SummarizationResult</span><span class="p">,</span>
<a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a><span class="p">)</span>
<a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">stellar_memory.vector_index</span><span class="w"> </span><span class="kn">import</span> <span class="n">VectorIndex</span><span class="p">,</span> <span class="n">BruteForceIndex</span><span class="p">,</span> <span class="n">BallTreeIndex</span><span class="p">,</span> <span class="n">create_vector_index</span>
<a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">stellar_memory.summarizer</span><span class="w"> </span><span class="kn">import</span> <span class="n">MemorySummarizer</span>
<a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a><span class="kn">from</span><span class="w"> </span><span class="nn">stellar_memory.adaptive_decay</span><span class="w"> </span><span class="kn">import</span> <span class="n">AdaptiveDecayManager</span>
<a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a><span class="kn">from</span><span class="w"> </span><span class="nn">stellar_memory.graph_analyzer</span><span class="w"> </span><span class="kn">import</span> <span class="n">GraphAnalyzer</span><span class="p">,</span> <span class="n">GraphStats</span><span class="p">,</span> <span class="n">CentralityResult</span>
<a id="__codelineno-37-17" name="__codelineno-37-17" href="#__codelineno-37-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">stellar_memory.providers</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProviderRegistry</span>
<a id="__codelineno-37-18" name="__codelineno-37-18" href="#__codelineno-37-18"></a>
<a id="__codelineno-37-19" name="__codelineno-37-19" href="#__codelineno-37-19"></a><span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.6.0&quot;</span>
</code></pre></div>
<hr />
<h2 id="5-implementation-order-detailed-steps">5. Implementation Order (Detailed Steps)</h2>
<table>
<thead>
<tr>
<th>Step</th>
<th>Feature</th>
<th>Files</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>F1</td>
<td><code>providers/__init__.py</code></td>
<td>ProviderRegistry + protocols</td>
</tr>
<tr>
<td>2</td>
<td>F1</td>
<td><code>providers/openai_provider.py</code></td>
<td>OpenAI LLM + Embedder</td>
</tr>
<tr>
<td>3</td>
<td>F1</td>
<td><code>providers/ollama_provider.py</code></td>
<td>Ollama LLM + Embedder</td>
</tr>
<tr>
<td>4</td>
<td>F1</td>
<td><code>config.py</code></td>
<td>EmbedderConfig.provider + LLMConfig.base_url</td>
</tr>
<tr>
<td>5</td>
<td>F1</td>
<td><code>importance_evaluator.py</code></td>
<td>ProviderRegistry 연동</td>
</tr>
<tr>
<td>6</td>
<td>F1</td>
<td><code>embedder.py</code></td>
<td>ProviderRegistry 연동</td>
</tr>
<tr>
<td>7</td>
<td>F2</td>
<td><code>vector_index.py</code></td>
<td>VectorIndex + BruteForce + BallTree</td>
</tr>
<tr>
<td>8</td>
<td>F2</td>
<td><code>config.py</code></td>
<td>VectorIndexConfig</td>
</tr>
<tr>
<td>9</td>
<td>F2</td>
<td><code>stellar.py</code></td>
<td>VectorIndex 연동 (auto_link, store, forget)</td>
</tr>
<tr>
<td>10</td>
<td>F3</td>
<td><code>summarizer.py</code></td>
<td>MemorySummarizer</td>
</tr>
<tr>
<td>11</td>
<td>F3</td>
<td><code>config.py</code></td>
<td>SummarizationConfig</td>
</tr>
<tr>
<td>12</td>
<td>F3</td>
<td><code>stellar.py</code></td>
<td>store() 요약 파이프라인</td>
</tr>
<tr>
<td>13</td>
<td>F3</td>
<td><code>event_bus.py</code></td>
<td>on_summarize 이벤트</td>
</tr>
<tr>
<td>14</td>
<td>F4</td>
<td><code>adaptive_decay.py</code></td>
<td>AdaptiveDecayManager</td>
</tr>
<tr>
<td>15</td>
<td>F4</td>
<td><code>config.py</code></td>
<td>AdaptiveDecayConfig, DecayConfig.adaptive</td>
</tr>
<tr>
<td>16</td>
<td>F4</td>
<td><code>decay_manager.py</code></td>
<td>Adaptive 연동</td>
</tr>
<tr>
<td>17</td>
<td>F4</td>
<td><code>event_bus.py</code></td>
<td>on_adaptive_decay 이벤트</td>
</tr>
<tr>
<td>18</td>
<td>F5</td>
<td><code>graph_analyzer.py</code></td>
<td>GraphAnalyzer + GraphStats</td>
</tr>
<tr>
<td>19</td>
<td>F5</td>
<td><code>config.py</code></td>
<td>GraphAnalyticsConfig</td>
</tr>
<tr>
<td>20</td>
<td>F5</td>
<td><code>stellar.py</code></td>
<td>GraphAnalyzer 연동</td>
</tr>
<tr>
<td>21</td>
<td>F5</td>
<td><code>models.py</code></td>
<td>SummarizationResult</td>
</tr>
<tr>
<td>22</td>
<td>All</td>
<td><code>mcp_server.py</code></td>
<td>memory_summarize + memory_graph_analyze</td>
</tr>
<tr>
<td>23</td>
<td>All</td>
<td><code>cli.py</code></td>
<td>summarize + graph 서브커맨드</td>
</tr>
<tr>
<td>24</td>
<td>All</td>
<td><code>__init__.py</code> + <code>pyproject.toml</code></td>
<td>exports + version 0.6.0</td>
</tr>
<tr>
<td>25</td>
<td>F1</td>
<td><code>tests/test_providers.py</code></td>
<td>10+ tests</td>
</tr>
<tr>
<td>26</td>
<td>F2</td>
<td><code>tests/test_vector_index.py</code></td>
<td>10+ tests</td>
</tr>
<tr>
<td>27</td>
<td>F3</td>
<td><code>tests/test_summarizer.py</code></td>
<td>10+ tests</td>
</tr>
<tr>
<td>28</td>
<td>F4</td>
<td><code>tests/test_adaptive_decay.py</code></td>
<td>8+ tests</td>
</tr>
<tr>
<td>29</td>
<td>F5</td>
<td><code>tests/test_graph_analyzer.py</code></td>
<td>10+ tests</td>
</tr>
<tr>
<td>30</td>
<td>All</td>
<td>Full regression</td>
<td>237 existing + 50+ new</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="6-backward-compatibility">6. Backward Compatibility</h2>
<table>
<thead>
<tr>
<th>Component</th>
<th>Strategy</th>
</tr>
</thead>
<tbody>
<tr>
<td>EmbedderConfig</td>
<td><code>provider</code> defaults to <code>"sentence-transformers"</code> (existing behavior)</td>
</tr>
<tr>
<td>LLMConfig</td>
<td><code>base_url</code> defaults to <code>None</code> (existing behavior)</td>
</tr>
<tr>
<td>VectorIndexConfig</td>
<td><code>backend</code> defaults to <code>"brute_force"</code> (same as O(n) scan)</td>
</tr>
<tr>
<td>SummarizationConfig</td>
<td><code>enabled</code> defaults to <code>True</code> but requires LLM; no-op with NullAdapter</td>
</tr>
<tr>
<td>AdaptiveDecayConfig</td>
<td><code>enabled</code> defaults to <code>False</code> (opt-in)</td>
</tr>
<tr>
<td>DecayConfig.adaptive</td>
<td>New field with default factory (no breaking change)</td>
</tr>
<tr>
<td>GraphAnalyticsConfig</td>
<td><code>enabled</code> defaults to <code>True</code> (new feature, no conflict)</td>
</tr>
<tr>
<td>store()</td>
<td>New <code>skip_summarize</code> param defaults to <code>False</code> (backward compatible)</td>
</tr>
<tr>
<td>All 237 existing tests</td>
<td>Must pass without modification</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="7-test-strategy">7. Test Strategy</h2>
<h3 id="f1-test_providerspy-10-tests">F1: test_providers.py (10+ tests)</h3>
<ol>
<li><code>test_registry_register_llm</code> - register + create</li>
<li><code>test_registry_register_embedder</code> - register + create</li>
<li><code>test_anthropic_provider_registered</code> - default registration</li>
<li><code>test_openai_provider_not_installed</code> - graceful fallback</li>
<li><code>test_ollama_provider_not_installed</code> - graceful fallback</li>
<li><code>test_create_evaluator_with_openai</code> - evaluator uses registry</li>
<li><code>test_create_embedder_with_provider</code> - embedder uses registry</li>
<li><code>test_null_provider_fallback</code> - NullProvider when nothing available</li>
<li><code>test_provider_config_base_url</code> - base_url passed correctly</li>
<li><code>test_provider_complete_returns_string</code> - protocol compliance</li>
</ol>
<h3 id="f2-test_vector_indexpy-10-tests">F2: test_vector_index.py (10+ tests)</h3>
<ol>
<li><code>test_brute_force_add_search</code> - basic add/search</li>
<li><code>test_brute_force_remove</code> - remove from index</li>
<li><code>test_ball_tree_add_search</code> - ball tree basic</li>
<li><code>test_ball_tree_large_dataset</code> - 1000+ vectors</li>
<li><code>test_ball_tree_rebuild</code> - rebuild from scratch</li>
<li><code>test_ball_tree_accuracy_vs_brute</code> - results match brute force</li>
<li><code>test_factory_brute_force</code> - factory creates correct type</li>
<li><code>test_factory_ball_tree</code> - factory creates correct type</li>
<li><code>test_factory_faiss_fallback</code> - FAISS not installed → BallTree</li>
<li><code>test_stellar_auto_link_uses_index</code> - integration test</li>
<li><code>test_index_size</code> - size tracking</li>
</ol>
<h3 id="f3-test_summarizerpy-10-tests">F3: test_summarizer.py (10+ tests)</h3>
<ol>
<li><code>test_should_summarize_short</code> - under min_length → False</li>
<li><code>test_should_summarize_long</code> - over min_length → True</li>
<li><code>test_summarize_success</code> - mock LLM returns summary</li>
<li><code>test_summarize_failure_returns_none</code> - LLM error → None</li>
<li><code>test_summarize_disabled</code> - config.enabled=False</li>
<li><code>test_store_with_summary_creates_two</code> - summary + original items</li>
<li><code>test_store_with_summary_creates_edge</code> - derived_from edge</li>
<li><code>test_store_short_no_summary</code> - short content stored normally</li>
<li><code>test_summarize_event_emitted</code> - on_summarize event fired</li>
<li><code>test_mcp_memory_summarize</code> - MCP tool integration</li>
<li><code>test_cli_summarize</code> - CLI command integration</li>
</ol>
<h3 id="f4-test_adaptive_decaypy-8-tests">F4: test_adaptive_decay.py (8+ tests)</h3>
<ol>
<li><code>test_effective_days_high_importance</code> - importance 0.9 → longer</li>
<li><code>test_effective_days_low_importance</code> - importance 0.1 → shorter</li>
<li><code>test_effective_days_zero_importance</code> - importance 0.0 → minimum</li>
<li><code>test_zone_factor_multiplier</code> - zone-based adjustment</li>
<li><code>test_decay_curve_linear</code> - linear curve</li>
<li><code>test_decay_curve_exponential</code> - exponential curve</li>
<li><code>test_decay_curve_sigmoid</code> - sigmoid curve</li>
<li><code>test_adaptive_integrated</code> - StellarMemory with adaptive decay</li>
<li><code>test_adaptive_disabled_same_as_before</code> - backward compat</li>
</ol>
<h3 id="f5-test_graph_analyzerpy-10-tests">F5: test_graph_analyzer.py (10+ tests)</h3>
<ol>
<li><code>test_stats_empty_graph</code> - no edges → zero stats</li>
<li><code>test_stats_with_edges</code> - correct node/edge count</li>
<li><code>test_centrality_top_k</code> - returns correct top nodes</li>
<li><code>test_communities_detection</code> - finds connected components</li>
<li><code>test_communities_min_size</code> - filters small communities</li>
<li><code>test_path_exists</code> - finds shortest path</li>
<li><code>test_path_not_exists</code> - returns None</li>
<li><code>test_path_direct</code> - direct connection</li>
<li><code>test_export_dot</code> - valid DOT output</li>
<li><code>test_export_graphml</code> - valid GraphML output</li>
<li><code>test_stellar_integration</code> - via memory.analyzer</li>
</ol>
<hr />
<h2 id="8-performance-targets">8. Performance Targets</h2>
<table>
<thead>
<tr>
<th>Metric</th>
<th style="text-align: center;">Current (v0.5.0)</th>
<th style="text-align: center;">Target (v0.6.0)</th>
</tr>
</thead>
<tbody>
<tr>
<td>auto_link (1K memories)</td>
<td style="text-align: center;">~50ms (O(n))</td>
<td style="text-align: center;">~5ms (O(log n))</td>
</tr>
<tr>
<td>auto_link (10K memories)</td>
<td style="text-align: center;">~500ms (O(n))</td>
<td style="text-align: center;">~50ms (O(log n))</td>
</tr>
<tr>
<td>recall top-10 (10K)</td>
<td style="text-align: center;">~100ms</td>
<td style="text-align: center;">~50ms</td>
</tr>
<tr>
<td>store with summary</td>
<td style="text-align: center;">N/A</td>
<td style="text-align: center;">&lt; 2s (LLM latency)</td>
</tr>
<tr>
<td>graph communities (1K nodes)</td>
<td style="text-align: center;">N/A</td>
<td style="text-align: center;">&lt; 100ms</td>
</tr>
<tr>
<td>adaptive decay check (10K items)</td>
<td style="text-align: center;">~1ms</td>
<td style="text-align: center;">~2ms (minimal overhead)</td>
</tr>
</tbody>
</table>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": ["content.code.copy", "navigation.sections", "search.suggest", "navigation.top"], "search": "../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>