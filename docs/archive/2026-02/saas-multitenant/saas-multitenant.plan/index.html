
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Celestial-structure-based AI memory management">
      
      
      
        <link rel="canonical" href="https://stellar-memory.com/docs/archive/2026-02/saas-multitenant/saas-multitenant.plan/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>SaaS Multi-Tenancy Planning Document - Stellar Memory</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#saas-multi-tenancy-planning-document" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Stellar Memory" class="md-header__button md-logo" aria-label="Stellar Memory" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Stellar Memory
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              SaaS Multi-Tenancy Planning Document
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/sangjun0000/stellar-memory" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    sangjun0000/stellar-memory
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Stellar Memory" class="md-nav__button md-logo" aria-label="Stellar Memory" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Stellar Memory
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/sangjun0000/stellar-memory" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    sangjun0000/stellar-memory
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../api-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../guides/chatbot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AI Chatbot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../guides/personal-assistant/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Personal Assistant
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../guides/code-assistant/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Code Assistant
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../guides/knowledge-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Knowledge Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    MCP Integration
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    MCP Integration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mcp/claude-code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Claude Code
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mcp/cursor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cursor
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mcp/tool-catalog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tool Catalog
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../rest-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    REST API
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Changelog
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Overview
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-purpose" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1 Purpose
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-background" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2 Background
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-related-documents" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.3 Related Documents
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-scope" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Scope
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Scope">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-in-scope" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 In Scope
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-out-of-scope" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 Out of Scope
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Requirements
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Requirements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-functional-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 Functional Requirements
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-non-functional-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 Non-Functional Requirements
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-success-criteria" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Success Criteria
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Success Criteria">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-definition-of-done" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 Definition of Done
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-quality-criteria" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2 Quality Criteria
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-risks-and-mitigation" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Risks and Mitigation
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-architecture-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Architecture Considerations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Architecture Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-project-level-selection" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 Project Level Selection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-key-architectural-decisions" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2 Key Architectural Decisions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.3 변경 대상 파일 목록
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-feature-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. Feature Details
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Feature Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#f1-postgresql" class="md-nav__link">
    <span class="md-ellipsis">
      
        F1: PostgreSQL 멀티테넌시 스키마
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f2-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        F2: API 테넌트 컨텍스트 전파
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f3" class="md-nav__link">
    <span class="md-ellipsis">
      
        F3: 티어 코드 동기화
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f4" class="md-nav__link">
    <span class="md-ellipsis">
      
        F4: 메모리 카운팅 수정
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f5-websocket-sync" class="md-nav__link">
    <span class="md-ellipsis">
      
        F5: WebSocket Sync 테넌트 격리
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-implementation-order" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. Implementation Order
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        9. Next Steps
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#version-history" class="md-nav__link">
    <span class="md-ellipsis">
      
        Version History
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="saas-multi-tenancy-planning-document">SaaS Multi-Tenancy Planning Document</h1>
<blockquote>
<p><strong>Summary</strong>: PostgreSQL 멀티테넌시 구현 및 백엔드 티어 동기화로 SaaS 제품 수준 달성</p>
<p><strong>Project</strong>: stellar-memory
<strong>Version</strong>: v1.0.0 → v1.1.0
<strong>Author</strong>: Claude
<strong>Date</strong>: 2026-02-20
<strong>Status</strong>: Draft</p>
</blockquote>
<hr />
<h2 id="1-overview">1. Overview</h2>
<h3 id="11-purpose">1.1 Purpose</h3>
<p>stellar-memory를 단일 사용자 데모에서 실제 SaaS 제품으로 전환한다. 핵심은 PostgreSQL 기반 멀티테넌시를 구현하여 각 유료 사용자가 독립된 메모리 공간을 가지도록 하는 것이다.</p>
<h3 id="12-background">1.2 Background</h3>
<p>현재 SaaS 준비도: <strong>65/100</strong></p>
<ul>
<li>Auth/Billing/API 인프라는 존재하나, 메모리 저장소가 테넌트 분리되지 않음</li>
<li><code>memories</code> 테이블에 <code>user_id</code> 컬럼 없음 → 모든 사용자가 동일 테이블 공유</li>
<li><code>get_memory_count(user_id)</code> 함수가 존재하지 않는 컬럼을 참조 → 에러</li>
<li>랜딩 페이지 가격(Free $0 / Pro $15 / Pro Max $29)과 백엔드 코드 불일치</li>
<li>WebSocket Sync가 모든 클라이언트에게 브로드캐스트 (테넌트 격리 없음)</li>
</ul>
<h3 id="13-related-documents">1.3 Related Documents</h3>
<ul>
<li>SaaS 준비도 평가: 이전 세션 결과 (65/100)</li>
<li>랜딩 페이지: <code>landing/index.html</code> (Free/Pro/Pro Max 3-tier)</li>
<li>백엔드 티어: <code>stellar_memory/billing/tiers.py</code></li>
</ul>
<hr />
<h2 id="2-scope">2. Scope</h2>
<h3 id="21-in-scope">2.1 In Scope</h3>
<ul>
<li>[ ] F1: PostgreSQL <code>memories</code> 테이블에 <code>user_id</code> 컬럼 추가 + 마이그레이션</li>
<li>[ ] F2: API 서버 테넌트 컨텍스트 전파 (인증 → 메모리 연산)</li>
<li>[ ] F3: 백엔드 티어 코드 동기화 (team → promax, 수치 일치)</li>
<li>[ ] F4: 메모리 카운팅 수정 (user_id 기반 정상 동작)</li>
<li>[ ] F5: WebSocket Sync 테넌트 격리</li>
</ul>
<h3 id="22-out-of-scope">2.2 Out of Scope</h3>
<ul>
<li>Cloud MCP 게이트웨이 (별도 피처로 분리)</li>
<li>MCP 서버 원격 인증 (별도 피처)</li>
<li>SSO/SAML 구현 (Pro Max 향후 로드맵)</li>
<li>결제 프로바이더 변경 (Lemon Squeezy 유지)</li>
</ul>
<hr />
<h2 id="3-requirements">3. Requirements</h2>
<h3 id="31-functional-requirements">3.1 Functional Requirements</h3>
<table>
<thead>
<tr>
<th>ID</th>
<th>Requirement</th>
<th>Priority</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>FR-01</td>
<td><code>memories</code> 테이블에 <code>user_id UUID</code> 컬럼 추가, <code>users.id</code> FK 연결</td>
<td>Critical</td>
<td>Pending</td>
</tr>
<tr>
<td>FR-02</td>
<td>모든 PostgreSQL 쿼리에 <code>WHERE user_id = $N</code> 필터 추가</td>
<td>Critical</td>
<td>Pending</td>
</tr>
<tr>
<td>FR-03</td>
<td><code>MemoryItem</code> 모델에 <code>user_id: str</code> 필드 추가</td>
<td>Critical</td>
<td>Pending</td>
</tr>
<tr>
<td>FR-04</td>
<td>API 미들웨어에서 <code>request.state.user_id</code> → StellarMemory 연산에 전달</td>
<td>Critical</td>
<td>Pending</td>
</tr>
<tr>
<td>FR-05</td>
<td><code>get_memory_count(user_id)</code> 정상 동작 (memories 테이블 기준)</td>
<td>High</td>
<td>Pending</td>
</tr>
<tr>
<td>FR-06</td>
<td><code>TIER_LIMITS</code> 코드: free 1,000 / pro 50,000 / promax 500,000</td>
<td>High</td>
<td>Pending</td>
</tr>
<tr>
<td>FR-07</td>
<td><code>team</code> → <code>promax</code> 네이밍 통일 (tiers.py, _TIER_ORDER 등)</td>
<td>High</td>
<td>Pending</td>
</tr>
<tr>
<td>FR-08</td>
<td>Pro Max <code>max_agents</code> 20 → Unlimited (-1 또는 999999)</td>
<td>High</td>
<td>Pending</td>
</tr>
<tr>
<td>FR-09</td>
<td>WebSocket Sync에 <code>user_id</code> 기반 룸/채널 격리</td>
<td>Medium</td>
<td>Pending</td>
</tr>
<tr>
<td>FR-10</td>
<td>PostgreSQL 인덱스: <code>(user_id, zone)</code>, <code>(user_id, total_score)</code> 추가</td>
<td>Medium</td>
<td>Pending</td>
</tr>
</tbody>
</table>
<h3 id="32-non-functional-requirements">3.2 Non-Functional Requirements</h3>
<table>
<thead>
<tr>
<th>Category</th>
<th>Criteria</th>
<th>Measurement Method</th>
</tr>
</thead>
<tbody>
<tr>
<td>Performance</td>
<td>user_id 필터 추가 후 쿼리 응답 &lt; 50ms</td>
<td>PostgreSQL EXPLAIN ANALYZE</td>
</tr>
<tr>
<td>Security</td>
<td>Row-Level Security (RLS) 정책 적용</td>
<td>PostgreSQL policy 검증</td>
</tr>
<tr>
<td>Data Isolation</td>
<td>타 사용자 메모리 접근 불가</td>
<td>교차 접근 테스트</td>
</tr>
<tr>
<td>Migration</td>
<td>기존 데이터 무중단 마이그레이션</td>
<td>Fly.io 배포 테스트</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="4-success-criteria">4. Success Criteria</h2>
<h3 id="41-definition-of-done">4.1 Definition of Done</h3>
<ul>
<li>[ ] PostgreSQL memories 테이블에 user_id 컬럼 존재</li>
<li>[ ] 모든 CRUD 쿼리가 user_id 필터 포함</li>
<li>[ ] API 엔드포인트에서 인증된 사용자의 메모리만 반환</li>
<li>[ ] 메모리 카운팅이 user_id 기준으로 정상 작동</li>
<li>[ ] 티어 코드가 랜딩 페이지와 일치 (free/pro/promax)</li>
<li>[ ] WebSocket Sync가 같은 사용자의 에이전트끼리만 동기화</li>
<li>[ ] 기존 테스트 통과 + 멀티테넌시 테스트 추가</li>
</ul>
<h3 id="42-quality-criteria">4.2 Quality Criteria</h3>
<ul>
<li>[ ] 교차 테넌트 접근 테스트 0건 통과</li>
<li>[ ] PostgreSQL RLS 정책 활성화</li>
<li>[ ] 마이그레이션 스크립트 롤백 가능</li>
</ul>
<hr />
<h2 id="5-risks-and-mitigation">5. Risks and Mitigation</h2>
<table>
<thead>
<tr>
<th>Risk</th>
<th>Impact</th>
<th>Likelihood</th>
<th>Mitigation</th>
</tr>
</thead>
<tbody>
<tr>
<td>기존 memories 데이터에 user_id 없음</td>
<td>High</td>
<td>High</td>
<td>마이그레이션 시 default user_id 할당, NULL 허용 후 점진적 적용</td>
</tr>
<tr>
<td>쿼리 성능 저하 (user_id 조건 추가)</td>
<td>Medium</td>
<td>Low</td>
<td>복합 인덱스 추가 (user_id, zone), (user_id, total_score)</td>
</tr>
<tr>
<td>StellarMemory 인스턴스 아키텍처 변경</td>
<td>High</td>
<td>Medium</td>
<td>기존 싱글 인스턴스 유지, storage layer에서만 user_id 필터</td>
</tr>
<tr>
<td>WebSocket Sync 하위 호환성</td>
<td>Medium</td>
<td>Medium</td>
<td>로컬 모드(기존)와 클라우드 모드(신규) 분리</td>
</tr>
<tr>
<td>테스트 깨짐</td>
<td>Medium</td>
<td>High</td>
<td>기존 테스트는 user_id=None 기본값으로 통과시킨 후 점진 전환</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="6-architecture-considerations">6. Architecture Considerations</h2>
<h3 id="61-project-level-selection">6.1 Project Level Selection</h3>
<table>
<thead>
<tr>
<th>Level</th>
<th>Characteristics</th>
<th>Recommended For</th>
<th style="text-align: center;">Selected</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Starter</strong></td>
<td>Simple structure</td>
<td>Static sites, portfolios</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td><strong>Dynamic</strong></td>
<td>Feature-based modules, BaaS integration</td>
<td>Web apps with backend, SaaS</td>
<td style="text-align: center;"><strong>X</strong></td>
</tr>
<tr>
<td><strong>Enterprise</strong></td>
<td>Strict layer separation, DI, microservices</td>
<td>High-traffic systems</td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
<h3 id="62-key-architectural-decisions">6.2 Key Architectural Decisions</h3>
<table>
<thead>
<tr>
<th>Decision</th>
<th>Options</th>
<th>Selected</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td>테넌트 격리 방식</td>
<td>Row-level (user_id) / Schema-per-tenant / DB-per-tenant</td>
<td><strong>Row-level</strong></td>
<td>단일 DB, 비용 효율적, Neon PostgreSQL 호환</td>
</tr>
<tr>
<td>StellarMemory 인스턴스</td>
<td>Per-user instance / Shared + user_id 파라미터</td>
<td><strong>Shared + user_id</strong></td>
<td>메모리 효율, 기존 아키텍처 최소 변경</td>
</tr>
<tr>
<td>마이그레이션 도구</td>
<td>Alembic / Raw SQL / Custom script</td>
<td><strong>Raw SQL</strong></td>
<td>단순, 의존성 없음, Neon 호환</td>
</tr>
<tr>
<td>티어 네이밍</td>
<td>team→promax rename / alias 추가</td>
<td><strong>Rename</strong></td>
<td>깔끔, 코드 일관성</td>
</tr>
<tr>
<td>Sync 격리</td>
<td>Room-based / Subscription filter / Separate channels</td>
<td><strong>Room-based</strong></td>
<td>WebSocket 표준 패턴, 구현 간단</td>
</tr>
</tbody>
</table>
<h3 id="63">6.3 변경 대상 파일 목록</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>수정 대상:
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>├── stellar_memory/
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>│   ├── models.py                    # MemoryItem에 user_id 추가
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>│   ├── storage/
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>│   │   ├── postgres_storage.py      # 스키마 + 모든 쿼리에 user_id
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>│   │   ├── sqlite_storage.py        # user_id 지원 (선택적)
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>│   │   └── __init__.py              # Storage 인터페이스에 user_id 파라미터
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>│   ├── server.py                    # 테넌트 컨텍스트 전파
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>│   ├── auth.py                      # get_memory_count 수정
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>│   ├── billing/
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>│   │   └── tiers.py                 # team→promax, 수치 변경
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>│   ├── orbit_manager.py             # store/recall에 user_id 전달
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>│   ├── stellar.py                   # user_id 파라미터 전파
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>│   └── sync/
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>│       ├── ws_server.py             # Room-based 격리
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>│       └── ws_client.py             # user_id 인증 추가
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>│
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>신규 파일:
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>├── migrations/
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>│   └── 001_add_user_id.sql          # PostgreSQL 마이그레이션
</code></pre></div>
<hr />
<h2 id="7-feature-details">7. Feature Details</h2>
<h3 id="f1-postgresql">F1: PostgreSQL 멀티테넌시 스키마</h3>
<p><strong>변경 파일</strong>: <code>stellar_memory/storage/postgres_storage.py</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1">-- 마이그레이션: 001_add_user_id.sql</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">memories</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">user_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_memories_user_zone</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">memories</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="k">zone</span><span class="p">);</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_memories_user_score</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">memories</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">total_score</span><span class="w"> </span><span class="k">DESC</span><span class="p">);</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="c1">-- RLS 정책</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">memories</span><span class="w"> </span><span class="n">ENABLE</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="k">LEVEL</span><span class="w"> </span><span class="k">SECURITY</span><span class="p">;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="n">memories_isolation</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">memories</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_setting</span><span class="p">(</span><span class="s1">&#39;app.current_user_id&#39;</span><span class="p">)::</span><span class="n">uuid</span><span class="p">);</span>
</code></pre></div>
<p><strong>MemoryItem 모델 변경</strong> (<code>models.py</code>):
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="nd">@dataclass</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">MemoryItem</span><span class="p">:</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="c1"># ... 기존 필드</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 신규 - 하위 호환성 위해 Optional</span>
</code></pre></div></p>
<h3 id="f2-api">F2: API 테넌트 컨텍스트 전파</h3>
<p><strong>변경 파일</strong>: <code>stellar_memory/server.py</code></p>
<p>현재 <code>request.state.user_id</code>는 설정되지만 메모리 연산에 전달되지 않음.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># 변경 전 (line 254-262):</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/store&quot;</span><span class="p">)</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">StoreRequest</span><span class="p">):</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>    <span class="n">item</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>  <span class="c1"># user_id 없음</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="c1"># 변경 후:</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/store&quot;</span><span class="p">)</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">StoreRequest</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>    <span class="n">user_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>    <span class="n">item</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</code></pre></div>
<p>모든 엔드포인트(store, recall, forget, search 등)에 동일 패턴 적용.</p>
<h3 id="f3">F3: 티어 코드 동기화</h3>
<p><strong>변경 파일</strong>: <code>stellar_memory/billing/tiers.py</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># 변경 전:</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="s2">&quot;free&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;max_memories&quot;</span><span class="p">:</span> <span class="mi">5_000</span><span class="p">,</span> <span class="s2">&quot;max_agents&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">}</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="s2">&quot;team&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;max_memories&quot;</span><span class="p">:</span> <span class="mi">500_000</span><span class="p">,</span> <span class="s2">&quot;max_agents&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="o">...</span><span class="p">}</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="c1"># 변경 후:</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="s2">&quot;free&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;max_memories&quot;</span><span class="p">:</span> <span class="mi">1_000</span><span class="p">,</span> <span class="s2">&quot;max_agents&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">}</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="s2">&quot;promax&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;max_memories&quot;</span><span class="p">:</span> <span class="mi">500_000</span><span class="p">,</span> <span class="s2">&quot;max_agents&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">}</span>  <span class="c1"># -1 = unlimited</span>
</code></pre></div>
<h3 id="f4">F4: 메모리 카운팅 수정</h3>
<p><strong>변경 파일</strong>: <code>stellar_memory/auth.py</code> (lines 249-262)</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># 변경 전: SELECT COUNT(*) FROM memories WHERE user_id = $1</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="c1"># → memories 테이블에 user_id가 없어서 에러</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="c1"># 변경 후: F1 마이그레이션 적용 후 동일 쿼리가 정상 동작</span>
</code></pre></div>
<h3 id="f5-websocket-sync">F5: WebSocket Sync 테넌트 격리</h3>
<p><strong>변경 파일</strong>: <code>stellar_memory/sync/ws_server.py</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># 변경 전: 모든 클라이언트에게 브로드캐스트</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">websocket</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_clients</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">websocket</span><span class="p">)</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="c1"># 변경 후: user_id 기반 룸 분리</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">websocket</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>    <span class="n">user_id</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authenticate</span><span class="p">(</span><span class="n">websocket</span><span class="p">)</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_rooms</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">websocket</span><span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="8-implementation-order">8. Implementation Order</h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>Phase 1 (Critical - 데이터 격리):
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>  F1 → F3 → F4 → F2
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>Phase 2 (Enhancement - 실시간):
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>  F5
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>구현 순서 상세:
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>1. F1: models.py + postgres_storage.py + migration SQL
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>2. F3: tiers.py (team→promax, 수치 변경)
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>3. F4: auth.py get_memory_count 수정
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>4. F2: server.py 모든 엔드포인트에 user_id 전파
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>5. F5: ws_server.py + ws_client.py 룸 기반 격리
</code></pre></div>
<hr />
<h2 id="9-next-steps">9. Next Steps</h2>
<ol>
<li>[ ] Write design document (<code>saas-multitenant.design.md</code>)</li>
<li>[ ] Implementation (5 features)</li>
<li>[ ] Gap analysis</li>
<li>[ ] Deploy to Fly.io</li>
</ol>
<hr />
<h2 id="version-history">Version History</h2>
<table>
<thead>
<tr>
<th>Version</th>
<th>Date</th>
<th>Changes</th>
<th>Author</th>
</tr>
</thead>
<tbody>
<tr>
<td>0.1</td>
<td>2026-02-20</td>
<td>Initial draft</td>
<td>Claude</td>
</tr>
</tbody>
</table>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": ["content.code.copy", "navigation.sections", "search.suggest", "navigation.top"], "search": "../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>