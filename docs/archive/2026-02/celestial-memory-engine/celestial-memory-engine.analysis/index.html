
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Celestial-structure-based AI memory management">
      
      
      
        <link rel="canonical" href="https://stellar-memory.com/docs/archive/2026-02/celestial-memory-engine/celestial-memory-engine.analysis/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>celestial-memory-engine Analysis Report - Stellar Memory</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#celestial-memory-engine-analysis-report" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Stellar Memory" class="md-header__button md-logo" aria-label="Stellar Memory" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Stellar Memory
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              celestial-memory-engine Analysis Report
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/sangjun0000/stellar-memory" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    sangjun0000/stellar-memory
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Stellar Memory" class="md-nav__button md-logo" aria-label="Stellar Memory" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Stellar Memory
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/sangjun0000/stellar-memory" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    sangjun0000/stellar-memory
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../api-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../guides/chatbot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AI Chatbot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../guides/personal-assistant/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Personal Assistant
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../guides/code-assistant/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Code Assistant
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../guides/knowledge-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Knowledge Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    MCP Integration
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    MCP Integration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mcp/claude-code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Claude Code
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mcp/cursor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cursor
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mcp/tool-catalog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tool Catalog
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../rest-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    REST API
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Changelog
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-analysis-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Analysis Overview
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Analysis Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-analysis-purpose" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1 Analysis Purpose
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-analysis-scope" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2 Analysis Scope
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-checklist-item-by-item-verification" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Checklist Item-by-Item Verification
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Checklist Item-by-Item Verification">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#f1-1-modelspy-celestialitem-scorebreakdown-zoneconfig-rebalanceresult" class="md-nav__link">
    <span class="md-ellipsis">
      
        F1-1: models.py -- CelestialItem, ScoreBreakdown, ZoneConfig, RebalanceResult
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f1-2-memory_functionpy-_recall_score-log-capped" class="md-nav__link">
    <span class="md-ellipsis">
      
        F1-2: memory_function.py -- _recall_score (log-capped)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f1-3-memory_functionpy-_freshness_score-recall-reset" class="md-nav__link">
    <span class="md-ellipsis">
      
        F1-3: memory_function.py -- _freshness_score (recall-reset)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f1-4-memory_functionpy-_context_score-cosine-similarity" class="md-nav__link">
    <span class="md-ellipsis">
      
        F1-4: memory_function.py -- _context_score (cosine similarity)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f1-5-memory_functionpy-calculate-_determine_zone" class="md-nav__link">
    <span class="md-ellipsis">
      
        F1-5: memory_function.py -- calculate + _determine_zone
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f2-1-storageinitpy-zonestorage-abc" class="md-nav__link">
    <span class="md-ellipsis">
      
        F2-1: storage/init.py -- ZoneStorage ABC
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f2-2-storagememorypy-inmemorystorage" class="md-nav__link">
    <span class="md-ellipsis">
      
        F2-2: storage/memory.py -- InMemoryStorage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f2-3-storagesqlitepy-sqlitestorage" class="md-nav__link">
    <span class="md-ellipsis">
      
        F2-3: storage/sqlite.py -- SqliteStorage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f3-1-importancepy-defaultevaluator-rulebasedevaluator" class="md-nav__link">
    <span class="md-ellipsis">
      
        F3-1: importance.py -- DefaultEvaluator, RuleBasedEvaluator
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f3-2-importancepy-llmevaluator" class="md-nav__link">
    <span class="md-ellipsis">
      
        F3-2: importance.py -- LLMEvaluator
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f4-1-zone_managerpy-zonemanager-place-move-evict-search-stats" class="md-nav__link">
    <span class="md-ellipsis">
      
        F4-1: zone_manager.py -- ZoneManager (place, move, evict, search, stats)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f4-2-zone_managerpy-forget_stale-enforce_capacity" class="md-nav__link">
    <span class="md-ellipsis">
      
        F4-2: zone_manager.py -- forget_stale + enforce_capacity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f5-1-rebalancerpy-rebalancerrebalance-manual" class="md-nav__link">
    <span class="md-ellipsis">
      
        F5-1: rebalancer.py -- Rebalancer.rebalance (manual)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f5-2-rebalancerpy-rebalancerstartstop-auto-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      
        F5-2: rebalancer.py -- Rebalancer.start/stop (auto scheduling)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f6-1-initpy-celestialmemorystore" class="md-nav__link">
    <span class="md-ellipsis">
      
        F6-1: init.py -- CelestialMemory.store
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f6-2-initpy-celestialmemoryrecall-recall-reset" class="md-nav__link">
    <span class="md-ellipsis">
      
        F6-2: init.py -- CelestialMemory.recall (+ recall-reset)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f6-3-initpy-celestialmemoryrebalance-stats-close" class="md-nav__link">
    <span class="md-ellipsis">
      
        F6-3: init.py -- CelestialMemory.rebalance, stats, close
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f7-1-adapterslangchainpy-langchainadapteras_retriever-as_memory" class="md-nav__link">
    <span class="md-ellipsis">
      
        F7-1: adapters/langchain.py -- LangChainAdapter.as_retriever, as_memory
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f7-2-adaptersopenaipy-openaiadapteras_tools-handle_tool_call" class="md-nav__link">
    <span class="md-ellipsis">
      
        F7-2: adapters/openai.py -- OpenAIAdapter.as_tools, handle_tool_call
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f7-3-adaptersanthropicpy-anthropicadapteras_mcp_tools-handle" class="md-nav__link">
    <span class="md-ellipsis">
      
        F7-3: adapters/anthropic.py -- AnthropicAdapter.as_mcp_tools, handle
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-additional-findings" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Additional Findings
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Additional Findings">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-added-features-design-x-implementation-o" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 Added Features (Design X, Implementation O)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-structural-differences" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 Structural Differences
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-design-document-issues" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.3 Design Document Issues
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-match-rate-summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Match Rate Summary
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Match Rate Summary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-per-item-results" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 Per-Item Results
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-score-calculation" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2 Score Calculation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-overall-scores" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Overall Scores
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Overall Scores">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#architecture-compliance-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture Compliance Details
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#convention-compliance-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        Convention Compliance Details
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-differences-detail" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Differences Detail
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Differences Detail">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-partial-items" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 PARTIAL Items
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.1 PARTIAL Items">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#f7-2-openai-adapter-handle_tool_call-response-format" class="md-nav__link">
    <span class="md-ellipsis">
      
        F7-2: OpenAI adapter handle_tool_call response format
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-design-document-math-error-not-an-implementation-gap" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2 Design Document Math Error (Not an implementation gap)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-recommended-actions" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. Recommended Actions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Recommended Actions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-optional-code-fix-low-priority" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.1 Optional Code Fix (Low Priority)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-design-document-updates-needed" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2 Design Document Updates Needed
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. Next Steps
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#version-history" class="md-nav__link">
    <span class="md-ellipsis">
      
        Version History
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="celestial-memory-engine-analysis-report">celestial-memory-engine Analysis Report</h1>
<blockquote>
<p><strong>Analysis Type</strong>: Gap Analysis (Design vs Implementation)</p>
<p><strong>Project</strong>: stellar-memory
<strong>Version</strong>: 2.0.0
<strong>Analyst</strong>: gap-detector
<strong>Date</strong>: 2026-02-18
<strong>Design Doc</strong>: <a href="../02-design/features/celestial-memory-engine.design.md">celestial-memory-engine.design.md</a></p>
</blockquote>
<hr />
<h2 id="1-analysis-overview">1. Analysis Overview</h2>
<h3 id="11-analysis-purpose">1.1 Analysis Purpose</h3>
<p>Verify that the 13 implementation files in <code>celestial_engine/</code> faithfully implement the design document for the Celestial Memory Engine v2. This analysis checks every class, method, field, algorithm, and constant against the design specification, covering all 20 checklist items.</p>
<h3 id="12-analysis-scope">1.2 Analysis Scope</h3>
<ul>
<li><strong>Design Document</strong>: <code>docs/02-design/features/celestial-memory-engine.design.md</code></li>
<li><strong>Implementation Path</strong>: <code>celestial_engine/</code> (13 files)</li>
<li><strong>Analysis Date</strong>: 2026-02-18</li>
</ul>
<hr />
<h2 id="2-checklist-item-by-item-verification">2. Checklist Item-by-Item Verification</h2>
<h3 id="f1-1-modelspy-celestialitem-scorebreakdown-zoneconfig-rebalanceresult">F1-1: models.py -- CelestialItem, ScoreBreakdown, ZoneConfig, RebalanceResult</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Design</th>
<th>Implementation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>CelestialItem fields</td>
<td>id, content, created_at, last_recalled_at, recall_count, arbitrary_importance, zone, metadata, embedding, total_score</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>CelestialItem.create()</td>
<td>Clamps importance [0,1], sets now for created_at &amp; last_recalled_at</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>ScoreBreakdown fields</td>
<td>recall_score, freshness_score, arbitrary_score, context_score, total, target_zone</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>ZoneConfig fields</td>
<td>zone_id, name, max_slots, score_min, score_max (default inf)</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>RebalanceResult fields</td>
<td>moved, evicted, forgotten, total_items, duration_ms</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>DEFAULT_ZONES location</td>
<td>Design Section 5.1 places in <code>celestial_engine/zones.py</code></td>
<td>Implementation places in <code>models.py</code></td>
<td>CHANGED</td>
</tr>
<tr>
<td>DEFAULT_ZONES values</td>
<td>5 zones: core(20,0.50), inner(100,0.30,0.50), outer(1000,0.10,0.30), belt(None,-0.10,0.10), cloud(None,-inf,-0.10)</td>
<td>Identical values</td>
<td>MATCH</td>
</tr>
</tbody>
</table>
<p><strong>Verdict</strong>: MATCH (the DEFAULT_ZONES file location change is a minor structural improvement -- keeping all model data together is cleaner)</p>
<h3 id="f1-2-memory_functionpy-_recall_score-log-capped">F1-2: memory_function.py -- _recall_score (log-capped)</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Design</th>
<th>Implementation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Formula</td>
<td><code>log(1 + count) / log(1 + MAX_RECALL_CAP)</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Guard for count &lt;= 0</td>
<td>Returns 0.0</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>MAX_RECALL_CAP default</td>
<td>1000</td>
<td>1000</td>
<td>MATCH</td>
</tr>
</tbody>
</table>
<p><strong>Verdict</strong>: MATCH</p>
<h3 id="f1-3-memory_functionpy-_freshness_score-recall-reset">F1-3: memory_function.py -- _freshness_score (recall-reset)</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Design</th>
<th>Implementation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>delta_t calculation</td>
<td><code>max(0.0, current_time - last_recalled_at)</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>raw decay</td>
<td><code>-alpha * delta_t</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Clamping</td>
<td><code>max(raw, freshness_floor)</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>floor &gt;= 0 guard</td>
<td>Returns 0.0</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Normalization</td>
<td><code>clamped / abs(freshness_floor)</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>freshness_alpha default</td>
<td>0.001</td>
<td>0.001</td>
<td>MATCH</td>
</tr>
<tr>
<td>freshness_floor default</td>
<td>-86400.0</td>
<td>-86400.0</td>
<td>MATCH</td>
</tr>
</tbody>
</table>
<p><strong>Design Document Math Error</strong> (flagged per instructions):</p>
<p>The design Section 4.2 claims: <code>F(1 day) = -0.001 * 86400 / 86400 = -1.0</code></p>
<p>This is <strong>mathematically incorrect</strong>. The actual calculation:
- <code>raw = -0.001 * 86400 = -86.4</code>
- <code>clamped = max(-86.4, -86400.0) = -86.4</code> (raw does NOT hit the floor)
- <code>normalized = -86.4 / 86400.0 = -0.001</code></p>
<p>So after 1 day: F = -0.001, NOT -1.0.</p>
<p>The freshness_floor of -86400.0 means F reaches -1.0 only when <code>raw = -86400</code>, i.e., when <code>0.001 * delta_t = 86400</code>, so <code>delta_t = 86,400,000 seconds = ~1000 days</code>.</p>
<p>The design proof in Section 4.2 incorrectly simplifies the division. The design scenarios in Section 4.3 that claim "1 day -&gt; F = -1.0" are also based on this error.</p>
<p><strong>However</strong>, the implementation correctly implements the formula as written in the code block (Section 4.1), which is self-consistent. The error is in the <strong>prose/proof section</strong>, not in the code specification. The implementation matches the code spec exactly.</p>
<p><strong>Verdict</strong>: MATCH (implementation matches the code specification; design prose/proof section has a documentation error)</p>
<h3 id="f1-4-memory_functionpy-_context_score-cosine-similarity">F1-4: memory_function.py -- _context_score (cosine similarity)</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Design</th>
<th>Implementation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>None guards</td>
<td>Returns 0.0 if either embedding is None</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Dot product</td>
<td><code>sum(a * b for a, b in zip(...))</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Norms</td>
<td><code>sum(x*x)^0.5</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Zero norm guard</td>
<td>Returns 0.0</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Final formula</td>
<td><code>dot / (norm_a * norm_b)</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
</tbody>
</table>
<p><strong>Verdict</strong>: MATCH</p>
<h3 id="f1-5-memory_functionpy-calculate-_determine_zone">F1-5: memory_function.py -- calculate + _determine_zone</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Design</th>
<th>Implementation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Weight defaults</td>
<td>w_r=0.25, w_f=0.30, w_a=0.25, w_c=0.20</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Total formula</td>
<td><code>w_r*R + w_f*F + w_a*A + w_c*C</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Zone thresholds</td>
<td>(0,0.50), (1,0.30), (2,0.10), (3,-0.10), (4,-inf)</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>_determine_zone loop</td>
<td>Iterates thresholds, returns first match, fallback 4</td>
<td>Design iterates <code>zone[1]</code> (tuple index), impl iterates <code>score_min</code> (destructured)</td>
<td>MATCH</td>
</tr>
<tr>
<td>MemoryFunctionConfig</td>
<td>Dataclass with 7 fields</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
</tbody>
</table>
<p><strong>Verdict</strong>: MATCH</p>
<h3 id="f2-1-storageinitpy-zonestorage-abc">F2-1: storage/<strong>init</strong>.py -- ZoneStorage ABC</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Design</th>
<th>Implementation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>File location</td>
<td>Design says <code>storage/base.py</code></td>
<td>Implementation is <code>storage/__init__.py</code></td>
<td>CHANGED</td>
</tr>
<tr>
<td>Abstract methods</td>
<td>store, get, remove, update, search, get_all, count, get_lowest_score_item</td>
<td>Identical set of 8 methods</td>
<td>MATCH</td>
</tr>
<tr>
<td>Method signatures</td>
<td>All match design signatures</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>TYPE_CHECKING import</td>
<td>Not in design</td>
<td>Implementation uses <code>TYPE_CHECKING</code> for CelestialItem</td>
<td>ADDED (improvement)</td>
</tr>
</tbody>
</table>
<p><strong>Verdict</strong>: MATCH (file location differs: <code>storage/base.py</code> vs <code>storage/__init__.py</code>, but this is a Pythonic improvement putting the ABC in the package init)</p>
<h3 id="f2-2-storagememorypy-inmemorystorage">F2-2: storage/memory.py -- InMemoryStorage</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Design</th>
<th>Implementation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Class name</td>
<td>InMemoryStorage</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Internal storage</td>
<td><code>dict[str, CelestialItem]</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>store()</td>
<td><code>self._items[item.id] = item</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>get()</td>
<td><code>self._items.get(item_id)</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>remove()</td>
<td><code>self._items.pop(item_id, None) is not None</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>update()</td>
<td><code>self._items[item.id] = item</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>search()</td>
<td>Case-insensitive keyword match, sort by total_score desc</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>get_all()</td>
<td><code>list(self._items.values())</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>count()</td>
<td><code>len(self._items)</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>get_lowest_score_item()</td>
<td><code>min(..., key=lambda i: i.total_score)</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Type hints</td>
<td>Design uses compact form (<code>def store(self, item):</code>)</td>
<td>Implementation uses full type hints</td>
<td>ADDED (improvement)</td>
</tr>
</tbody>
</table>
<p><strong>Verdict</strong>: MATCH</p>
<h3 id="f2-3-storagesqlitepy-sqlitestorage">F2-3: storage/sqlite.py -- SqliteStorage</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Design</th>
<th>Implementation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Table naming</td>
<td><code>memories_zone_{zone_id}</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>WAL mode</td>
<td><code>PRAGMA journal_mode=WAL</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Schema columns</td>
<td>10 columns matching CelestialItem fields</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Score index</td>
<td><code>idx_{table}_score ON {table}(total_score)</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>store() UPSERT</td>
<td><code>INSERT OR REPLACE</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Embedding serialization</td>
<td>struct.pack/unpack float array</td>
<td>Identical algorithm</td>
<td>MATCH</td>
</tr>
<tr>
<td>_row_to_item()</td>
<td>Positional tuple unpacking</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Thread safety</td>
<td>Design: no threading.Lock</td>
<td>Implementation: adds <code>threading.Lock</code> for store/remove</td>
<td>ADDED (improvement)</td>
</tr>
<tr>
<td>Helper functions</td>
<td>Design: instance methods (<code>self._serialize_embedding</code>)</td>
<td>Implementation: module-level functions (<code>_serialize_embedding</code>)</td>
<td>CHANGED</td>
</tr>
<tr>
<td>close() method</td>
<td>Not in design</td>
<td>Implementation adds <code>close()</code></td>
<td>ADDED</td>
</tr>
</tbody>
</table>
<p><strong>Verdict</strong>: MATCH (thread safety lock and module-level helpers are improvements)</p>
<h3 id="f3-1-importancepy-defaultevaluator-rulebasedevaluator">F3-1: importance.py -- DefaultEvaluator, RuleBasedEvaluator</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Design</th>
<th>Implementation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>ImportanceEvaluator ABC</td>
<td><code>evaluate(content: str) -&gt; float</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>DefaultEvaluator</td>
<td>Returns 0.5</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>RuleBasedEvaluator patterns</td>
<td>FACTUAL(3), EMOTIONAL(2), ACTIONABLE(2), EXPLICIT(2)</td>
<td>Identical pattern sets</td>
<td>MATCH</td>
</tr>
<tr>
<td>Weights</td>
<td>0.25<em>f + 0.25</em>e + 0.30<em>a + 0.20</em>x</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>_score()</td>
<td><code>min(matches/max(len(patterns),1), 1.0)</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>re import</td>
<td>Design imports re inside evaluate()</td>
<td>Implementation imports re at module level</td>
<td>CHANGED (improvement)</td>
</tr>
</tbody>
</table>
<p><strong>Verdict</strong>: MATCH</p>
<h3 id="f3-2-importancepy-llmevaluator">F3-2: importance.py -- LLMEvaluator</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Design</th>
<th>Implementation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Constructor</td>
<td><code>llm_callable=None</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Fallback</td>
<td>RuleBasedEvaluator</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>evaluate() flow</td>
<td>None check -&gt; try LLM -&gt; except fallback</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>_call_llm() prompt</td>
<td>Exact same prompt text</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>JSON parsing</td>
<td><code>json.loads(raw)</code>, extract "importance", clamp [0,1]</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Logging on failure</td>
<td>Design: bare <code>except Exception</code></td>
<td>Implementation: <code>except Exception as exc</code> with logger.warning</td>
<td>CHANGED (improvement)</td>
</tr>
</tbody>
</table>
<p><strong>Verdict</strong>: MATCH</p>
<h3 id="f4-1-zone_managerpy-zonemanager-place-move-evict-search-stats">F4-1: zone_manager.py -- ZoneManager (place, move, evict, search, stats)</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Design</th>
<th>Implementation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Constructor zones</td>
<td><code>{z.zone_id: z for z in (zones or DEFAULT_ZONES)}</code></td>
<td>Identical logic</td>
<td>MATCH</td>
</tr>
<tr>
<td>Storage assignment</td>
<td>zone_id &lt;= 1 -&gt; InMemory, else -&gt; Sqlite</td>
<td>Implementation adds: <code>or db_path == ":memory:"</code> -&gt; all InMemory</td>
<td>CHANGED (improvement for testing)</td>
</tr>
<tr>
<td>place()</td>
<td>Sets zone, score, checks capacity, stores</td>
<td>Implementation adds <code>_clamp_zone()</code> call</td>
<td>CHANGED (improvement)</td>
</tr>
<tr>
<td>move()</td>
<td>Get from source, remove, place in target</td>
<td>Identical logic</td>
<td>MATCH</td>
</tr>
<tr>
<td>get_all_items()</td>
<td>Collect from all storages</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>search()</td>
<td>Zone 0-&gt;4 order, early stop at limit</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>stats()</td>
<td>Returns <code>{zid: (count, max_slots)}</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>_evict_lowest()</td>
<td>Remove lowest, place in zone+1</td>
<td>Implementation adds: logger.info when no next zone exists</td>
<td>CHANGED (improvement)</td>
</tr>
<tr>
<td>find_item()</td>
<td>Not in design</td>
<td>Implementation adds cross-zone item finder</td>
<td>ADDED</td>
</tr>
<tr>
<td>_clamp_zone()</td>
<td>Not in design</td>
<td>Implementation adds zone boundary clamping</td>
<td>ADDED</td>
</tr>
</tbody>
</table>
<p><strong>Verdict</strong>: MATCH (additions are defensive improvements)</p>
<h3 id="f4-2-zone_managerpy-forget_stale-enforce_capacity">F4-2: zone_manager.py -- forget_stale + enforce_capacity</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Design</th>
<th>Implementation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>forget_stale()</td>
<td>Deletes Cloud zone items older than max_age_seconds</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>enforce_capacity()</td>
<td>Iterates zones, evicts while over max_slots</td>
<td>Implementation adds infinite-loop guard: <code>if storage.count() &gt;= before: break</code></td>
<td>CHANGED (improvement)</td>
</tr>
</tbody>
</table>
<p><strong>Verdict</strong>: MATCH</p>
<h3 id="f5-1-rebalancerpy-rebalancerrebalance-manual">F5-1: rebalancer.py -- Rebalancer.rebalance (manual)</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Design</th>
<th>Implementation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Score recalculation</td>
<td>For all items, calculate new score</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Move detection</td>
<td>If target_zone != current zone</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Moves list</td>
<td>Design: <code>list[tuple[CelestialItem, int, int, float]]</code></td>
<td>Implementation: <code>list[tuple[str, int, int, float]]</code> (stores item_id, not item)</td>
<td>CHANGED</td>
</tr>
<tr>
<td>Sort order</td>
<td>High score first (reverse=True)</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Move execution</td>
<td>Design: <code>self._zone_mgr.move(item.id, ...)</code></td>
<td>Implementation: <code>self._zone_mgr.move(item_id, ...)</code></td>
<td>MATCH (consistent with tuple change)</td>
</tr>
<tr>
<td>enforce_capacity</td>
<td>Called after moves</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>forget_stale</td>
<td>Called after enforce</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>duration_ms</td>
<td><code>(time.time() - start) * 1000</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>RebalanceResult</td>
<td>All fields populated</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
</tbody>
</table>
<p><strong>Verdict</strong>: MATCH (storing item_id instead of item object in moves list is an improvement -- avoids holding stale object references)</p>
<h3 id="f5-2-rebalancerpy-rebalancerstartstop-auto-scheduling">F5-2: rebalancer.py -- Rebalancer.start/stop (auto scheduling)</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Design</th>
<th>Implementation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Constructor params</td>
<td>memory_fn, zone_mgr, interval_seconds=300, auto_forget_seconds=86400*90</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>_timer type</td>
<td><code>threading.Timer \| None</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>_running flag</td>
<td>Boolean</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>start()</td>
<td>Sets _running=True, calls _schedule_next</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>stop()</td>
<td>Sets _running=False, cancels timer</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>_schedule_next()</td>
<td>Creates daemon Timer, starts it</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>_tick()</td>
<td>try rebalance, log if changes, except log error, finally schedule next</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
</tbody>
</table>
<p><strong>Verdict</strong>: MATCH</p>
<h3 id="f6-1-initpy-celestialmemorystore">F6-1: <strong>init</strong>.py -- CelestialMemory.store</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Design</th>
<th>Implementation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Constructor params</td>
<td>db_path, zones, memory_fn_config, evaluator, rebalance_interval, auto_forget_days, embed_fn</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Auto-start rebalancer</td>
<td><code>self._rebalancer.start()</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>store() signature</td>
<td><code>(content, importance=None, metadata=None) -&gt; CelestialItem</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Auto-evaluate importance</td>
<td><code>self._evaluator.evaluate(content)</code> when None</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Embed if embed_fn</td>
<td><code>item.embedding = self._embed_fn(content)</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Calculate + place</td>
<td><code>self._fn.calculate(item, now)</code> -&gt; <code>self._zone_mgr.place(...)</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
</tbody>
</table>
<p><strong>Verdict</strong>: MATCH</p>
<h3 id="f6-2-initpy-celestialmemoryrecall-recall-reset">F6-2: <strong>init</strong>.py -- CelestialMemory.recall (+ recall-reset)</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Design</th>
<th>Implementation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>recall() signature</td>
<td><code>(query, limit=5) -&gt; list[CelestialItem]</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Query embedding</td>
<td><code>self._embed_fn(query) if self._embed_fn else None</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Zone search</td>
<td><code>self._zone_mgr.search(query, limit, query_embedding)</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Recall count increment</td>
<td><code>item.recall_count += 1</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Freshness reset</td>
<td><code>item.last_recalled_at = now</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Score recalculation</td>
<td><code>self._fn.calculate(item, now, query_embedding)</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Zone move check</td>
<td>If target_zone changed, move; else update in place</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Private storage access</td>
<td><code>self._zone_mgr._storages[item.zone].update(item)</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
</tbody>
</table>
<p><strong>Verdict</strong>: MATCH</p>
<h3 id="f6-3-initpy-celestialmemoryrebalance-stats-close">F6-3: <strong>init</strong>.py -- CelestialMemory.rebalance, stats, close</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Design</th>
<th>Implementation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>rebalance()</td>
<td>Delegates to <code>self._rebalancer.rebalance()</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>stats()</td>
<td>Returns <code>{zones: {zid: {count, capacity}}, total: N}</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>close()</td>
<td>Calls <code>self._rebalancer.stop()</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
</tbody>
</table>
<p><strong>Verdict</strong>: MATCH</p>
<h3 id="f7-1-adapterslangchainpy-langchainadapteras_retriever-as_memory">F7-1: adapters/langchain.py -- LangChainAdapter.as_retriever, as_memory</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Design</th>
<th>Implementation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Constructor</td>
<td><code>(memory: CelestialMemory)</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>as_retriever(k=5)</td>
<td>Returns BaseRetriever subclass</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>_get_relevant_documents</td>
<td>Calls mem.recall, wraps in Document</td>
<td>Implementation adds <code>**kwargs</code> parameter</td>
<td>CHANGED (minor, for LangChain compat)</td>
</tr>
<tr>
<td>as_memory()</td>
<td>Returns ConversationBufferMemory subclass</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>save_context()</td>
<td>Formats Human/AI, stores in memory</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>load_memory_variables()</td>
<td>Recalls and joins content</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
</tbody>
</table>
<p><strong>Verdict</strong>: MATCH</p>
<h3 id="f7-2-adaptersopenaipy-openaiadapteras_tools-handle_tool_call">F7-2: adapters/openai.py -- OpenAIAdapter.as_tools, handle_tool_call</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Design</th>
<th>Implementation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>as_tools()</td>
<td>2 tools: celestial_store, celestial_recall</td>
<td>Identical structure</td>
<td>MATCH</td>
</tr>
<tr>
<td>Tool descriptions</td>
<td>Design: <code>"Memory content"</code></td>
<td>Implementation: <code>"Memory content to store"</code></td>
<td>CHANGED (minor)</td>
</tr>
<tr>
<td>Tool descriptions</td>
<td>Design: <code>"0.0-1.0"</code></td>
<td>Implementation: <code>"Importance score 0.0-1.0"</code></td>
<td>CHANGED (minor)</td>
</tr>
<tr>
<td>Tool descriptions</td>
<td>Design: <code>"Search query"</code></td>
<td>Implementation: <code>"Search query for memory recall"</code></td>
<td>CHANGED (minor)</td>
</tr>
<tr>
<td>Tool descriptions</td>
<td>Design: <code>"Max results"</code></td>
<td>Implementation: <code>"Maximum number of results"</code></td>
<td>CHANGED (minor)</td>
</tr>
<tr>
<td>handle_tool_call store</td>
<td>Design returns <code>{"id", "zone"}</code></td>
<td>Implementation returns <code>{"id", "zone", "score"}</code></td>
<td>CHANGED</td>
</tr>
<tr>
<td>handle_tool_call recall</td>
<td>Design returns <code>[{"content", "zone"}]</code></td>
<td>Implementation returns <code>[{"content", "zone", "score"}]</code></td>
<td>CHANGED</td>
</tr>
<tr>
<td>json import</td>
<td>Design: inside method</td>
<td>Implementation: at module level</td>
<td>CHANGED (improvement)</td>
</tr>
</tbody>
</table>
<p><strong>Verdict</strong>: PARTIAL -- The response format includes an extra <code>score</code> field not specified in design. This is an additive change (non-breaking) but represents a design deviation. The tool descriptions are more verbose than designed.</p>
<h3 id="f7-3-adaptersanthropicpy-anthropicadapteras_mcp_tools-handle">F7-3: adapters/anthropic.py -- AnthropicAdapter.as_mcp_tools, handle</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Design</th>
<th>Implementation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>as_mcp_tools()</td>
<td>2 tools: celestial_store, celestial_recall</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>Tool schemas</td>
<td>Identical input_schema structures</td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>handle() store</td>
<td>Design returns <code>{"id", "zone", "score"}</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
<tr>
<td>handle() recall</td>
<td>Design returns <code>{"memories": [{"content", "zone", "score"}]}</code></td>
<td>Identical</td>
<td>MATCH</td>
</tr>
</tbody>
</table>
<p><strong>Verdict</strong>: MATCH</p>
<hr />
<h2 id="3-additional-findings">3. Additional Findings</h2>
<h3 id="31-added-features-design-x-implementation-o">3.1 Added Features (Design X, Implementation O)</h3>
<table>
<thead>
<tr>
<th>Item</th>
<th>Implementation Location</th>
<th>Description</th>
<th>Impact</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>find_item()</code></td>
<td><code>zone_manager.py:117-123</code></td>
<td>Cross-zone item lookup</td>
<td>Low (utility method)</td>
</tr>
<tr>
<td><code>_clamp_zone()</code></td>
<td><code>zone_manager.py:137-143</code></td>
<td>Zone ID boundary clamping</td>
<td>Low (defensive)</td>
</tr>
<tr>
<td><code>close()</code></td>
<td><code>storage/sqlite.py:116-117</code></td>
<td>SQLite connection cleanup</td>
<td>Low (resource management)</td>
</tr>
<tr>
<td><code>threading.Lock</code></td>
<td><code>storage/sqlite.py:21</code></td>
<td>Thread-safe SQLite writes</td>
<td>Low (concurrency safety)</td>
</tr>
<tr>
<td><code>TYPE_CHECKING</code></td>
<td><code>storage/__init__.py:6-9</code></td>
<td>Lazy type imports</td>
<td>Low (circular import prevention)</td>
</tr>
<tr>
<td><code>__all__</code> exports</td>
<td><code>__init__.py:38-53</code></td>
<td>Explicit public API</td>
<td>Low (API clarity)</td>
</tr>
<tr>
<td><code>logger</code></td>
<td><code>importance.py:9</code></td>
<td>Logging for LLM failures</td>
<td>Low (observability)</td>
</tr>
<tr>
<td>Infinite-loop guard</td>
<td><code>zone_manager.py:103-106</code></td>
<td><code>enforce_capacity</code> safety break</td>
<td>Low (robustness)</td>
</tr>
<tr>
<td><code>db_path == ":memory:"</code></td>
<td><code>zone_manager.py:27</code></td>
<td>All-InMemory for test convenience</td>
<td>Low (testability)</td>
</tr>
<tr>
<td><code>**kwargs</code> in retriever</td>
<td><code>adapters/langchain.py:33</code></td>
<td>LangChain API compatibility</td>
<td>Low (framework compat)</td>
</tr>
</tbody>
</table>
<h3 id="32-structural-differences">3.2 Structural Differences</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Design</th>
<th>Implementation</th>
<th>Impact</th>
</tr>
</thead>
<tbody>
<tr>
<td>DEFAULT_ZONES location</td>
<td><code>celestial_engine/zones.py</code> (Section 5.1)</td>
<td><code>celestial_engine/models.py</code></td>
<td>Low -- no separate zones.py needed</td>
</tr>
<tr>
<td>ZoneStorage ABC location</td>
<td><code>storage/base.py</code> (Section 8.1)</td>
<td><code>storage/__init__.py</code></td>
<td>Low -- Pythonic convention</td>
</tr>
<tr>
<td>Rebalancer moves tuple</td>
<td><code>tuple[CelestialItem, ...]</code></td>
<td><code>tuple[str, ...]</code> (item_id)</td>
<td>Low -- avoids stale refs</td>
</tr>
<tr>
<td>Helper functions scope</td>
<td>Instance methods in SqliteStorage</td>
<td>Module-level functions</td>
<td>Low -- reduces class complexity</td>
</tr>
</tbody>
</table>
<h3 id="33-design-document-issues">3.3 Design Document Issues</h3>
<table>
<thead>
<tr>
<th>Issue</th>
<th>Location</th>
<th>Severity</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Math error in proof</td>
<td>Design Section 4.2</td>
<td>Medium</td>
<td>Claims <code>F(1 day) = -1.0</code> but actual value is <code>F(1 day) = -0.001</code>. The formula <code>F(1 day) = -0.001 * 86400 / 86400</code> incorrectly cancels the 86400 terms. The correct chain is: <code>raw = -0.001 * 86400 = -86.4</code>, <code>clamped = max(-86.4, -86400) = -86.4</code>, <code>normalized = -86.4 / 86400 = -0.001</code>. F reaches -1.0 after ~1000 days, not 1 day.</td>
</tr>
<tr>
<td>Scenario errors</td>
<td>Design Section 4.3</td>
<td>Medium</td>
<td>Scenarios 2, 3, 4 all assume F = -1.0 after 1 day, which is incorrect per the implemented formula.</td>
</tr>
<tr>
<td>File path mismatch</td>
<td>Design Section 5.1 says <code>zones.py</code>, Section 8.1 says <code>storage/base.py</code></td>
<td>Low</td>
<td>Implementation uses <code>models.py</code> and <code>storage/__init__.py</code> respectively.</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="4-match-rate-summary">4. Match Rate Summary</h2>
<h3 id="41-per-item-results">4.1 Per-Item Results</h3>
<table>
<thead>
<tr>
<th>#</th>
<th>ID</th>
<th>File</th>
<th>Verdict</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>F1-1</td>
<td>models.py</td>
<td>MATCH</td>
<td>All 4 dataclasses + DEFAULT_ZONES (in models.py instead of zones.py)</td>
</tr>
<tr>
<td>2</td>
<td>F1-2</td>
<td>memory_function.py</td>
<td>MATCH</td>
<td>Log-capped recall score exact match</td>
</tr>
<tr>
<td>3</td>
<td>F1-3</td>
<td>memory_function.py</td>
<td>MATCH</td>
<td>Recall-reset freshness exact match (design prose has math error)</td>
</tr>
<tr>
<td>4</td>
<td>F1-4</td>
<td>memory_function.py</td>
<td>MATCH</td>
<td>Cosine similarity exact match</td>
</tr>
<tr>
<td>5</td>
<td>F1-5</td>
<td>memory_function.py</td>
<td>MATCH</td>
<td>Calculate + zone determination exact match</td>
</tr>
<tr>
<td>6</td>
<td>F2-1</td>
<td>storage/<strong>init</strong>.py</td>
<td>MATCH</td>
<td>ABC in <strong>init</strong>.py instead of base.py</td>
</tr>
<tr>
<td>7</td>
<td>F2-2</td>
<td>storage/memory.py</td>
<td>MATCH</td>
<td>InMemoryStorage exact match</td>
</tr>
<tr>
<td>8</td>
<td>F2-3</td>
<td>storage/sqlite.py</td>
<td>MATCH</td>
<td>SqliteStorage with added thread safety</td>
</tr>
<tr>
<td>9</td>
<td>F3-1</td>
<td>importance.py</td>
<td>MATCH</td>
<td>DefaultEvaluator + RuleBasedEvaluator exact match</td>
</tr>
<tr>
<td>10</td>
<td>F3-2</td>
<td>importance.py</td>
<td>MATCH</td>
<td>LLMEvaluator with improved error logging</td>
</tr>
<tr>
<td>11</td>
<td>F4-1</td>
<td>zone_manager.py</td>
<td>MATCH</td>
<td>Core methods match + defensive additions</td>
</tr>
<tr>
<td>12</td>
<td>F4-2</td>
<td>zone_manager.py</td>
<td>MATCH</td>
<td>forget_stale + enforce_capacity with safety guard</td>
</tr>
<tr>
<td>13</td>
<td>F5-1</td>
<td>rebalancer.py</td>
<td>MATCH</td>
<td>Rebalance logic match (item_id tuple optimization)</td>
</tr>
<tr>
<td>14</td>
<td>F5-2</td>
<td>rebalancer.py</td>
<td>MATCH</td>
<td>start/stop/scheduling exact match</td>
</tr>
<tr>
<td>15</td>
<td>F6-1</td>
<td><strong>init</strong>.py</td>
<td>MATCH</td>
<td>CelestialMemory.store exact match</td>
</tr>
<tr>
<td>16</td>
<td>F6-2</td>
<td><strong>init</strong>.py</td>
<td>MATCH</td>
<td>CelestialMemory.recall with recall-reset exact match</td>
</tr>
<tr>
<td>17</td>
<td>F6-3</td>
<td><strong>init</strong>.py</td>
<td>MATCH</td>
<td>rebalance, stats, close exact match</td>
</tr>
<tr>
<td>18</td>
<td>F7-1</td>
<td>adapters/langchain.py</td>
<td>MATCH</td>
<td>LangChainAdapter with minor **kwargs addition</td>
</tr>
<tr>
<td>19</td>
<td>F7-2</td>
<td>adapters/openai.py</td>
<td>PARTIAL</td>
<td>Response includes extra <code>score</code> field; descriptions more verbose</td>
</tr>
<tr>
<td>20</td>
<td>F7-3</td>
<td>adapters/anthropic.py</td>
<td>MATCH</td>
<td>AnthropicAdapter exact match</td>
</tr>
</tbody>
</table>
<h3 id="42-score-calculation">4.2 Score Calculation</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>MATCH items:    19 / 20 = 95.0%
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>PARTIAL items:   1 / 20 =  5.0%  (F7-2: OpenAI adapter response format)
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>MISSING items:   0 / 20 =  0.0%
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>Weighted Score:
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>  MATCH    = 19 * 1.0  = 19.0
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>  PARTIAL  =  1 * 0.5  =  0.5
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>  MISSING  =  0 * 0.0  =  0.0
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>  Total    = 19.5 / 20 = 97.5%
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>+-------------------------------------------------+
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>|  Overall Match Rate: 97.5% (19.5 / 20)          |
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>+-------------------------------------------------+
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>|  MATCH:     19 items (95%)                       |
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>|  PARTIAL:    1 item  ( 5%)  -- OpenAI adapter    |
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>|  MISSING:    0 items ( 0%)                       |
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>+-------------------------------------------------+
</code></pre></div>
<hr />
<h2 id="5-overall-scores">5. Overall Scores</h2>
<table>
<thead>
<tr>
<th>Category</th>
<th style="text-align: center;">Score</th>
<th style="text-align: center;">Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Design Match</td>
<td style="text-align: center;">97.5%</td>
<td style="text-align: center;">PASS</td>
</tr>
<tr>
<td>Architecture Compliance</td>
<td style="text-align: center;">100%</td>
<td style="text-align: center;">PASS</td>
</tr>
<tr>
<td>Convention Compliance</td>
<td style="text-align: center;">98%</td>
<td style="text-align: center;">PASS</td>
</tr>
<tr>
<td><strong>Overall</strong></td>
<td style="text-align: center;"><strong>97.5%</strong></td>
<td style="text-align: center;"><strong>PASS</strong></td>
</tr>
</tbody>
</table>
<h3 id="architecture-compliance-details">Architecture Compliance Details</h3>
<ul>
<li>Single responsibility: Each module has one clear role -- PASS</li>
<li>Dependency direction: models &lt;- memory_function &lt;- zone_manager &lt;- rebalancer &lt;- facade -- PASS</li>
<li>No circular imports: TYPE_CHECKING used correctly -- PASS</li>
<li>Storage abstraction: ABC properly defined and implemented -- PASS</li>
</ul>
<h3 id="convention-compliance-details">Convention Compliance Details</h3>
<table>
<thead>
<tr>
<th>Convention</th>
<th style="text-align: center;">Score</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Class naming (PascalCase)</td>
<td style="text-align: center;">100%</td>
<td>All 14 classes follow PascalCase</td>
</tr>
<tr>
<td>Function naming (snake_case)</td>
<td style="text-align: center;">100%</td>
<td>All methods follow snake_case</td>
</tr>
<tr>
<td>Constant naming (UPPER_SNAKE_CASE)</td>
<td style="text-align: center;">100%</td>
<td>DEFAULT_ZONES, FACTUAL_PATTERNS, etc.</td>
</tr>
<tr>
<td>File naming (snake_case.py)</td>
<td style="text-align: center;">100%</td>
<td>All 13 files follow snake_case</td>
</tr>
<tr>
<td>Private prefix (_)</td>
<td style="text-align: center;">100%</td>
<td>All private members use underscore prefix</td>
</tr>
<tr>
<td><code>from __future__ import annotations</code></td>
<td style="text-align: center;">100%</td>
<td>Present in all 13 files</td>
</tr>
<tr>
<td>Type hints on public methods</td>
<td style="text-align: center;">95%</td>
<td><code>embed_fn</code> parameter lacks type hint</td>
</tr>
<tr>
<td>Import order (stdlib, local)</td>
<td style="text-align: center;">100%</td>
<td>All files follow correct order</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="6-differences-detail">6. Differences Detail</h2>
<h3 id="61-partial-items">6.1 PARTIAL Items</h3>
<h4 id="f7-2-openai-adapter-handle_tool_call-response-format">F7-2: OpenAI adapter handle_tool_call response format</h4>
<p><strong>Design</strong> (Section 10.2):
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># celestial_store response:</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;zone&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">zone</span><span class="p">}</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="c1"># celestial_recall response:</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="p">[{</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;zone&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">zone</span><span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
</code></pre></div></p>
<p><strong>Implementation</strong> (<code>celestial_engine/adapters/openai.py:82,89</code>):
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># celestial_store response:</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;zone&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">zone</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">total_score</span><span class="p">}</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="c1"># celestial_recall response:</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="p">[{</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;zone&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">zone</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">total_score</span><span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
</code></pre></div></p>
<p><strong>Impact</strong>: Low-Medium. The <code>score</code> field is additive (non-breaking for consumers), and matches the AnthropicAdapter behavior which was designed with <code>score</code>. This appears to be an intentional improvement for consistency across adapters. The tool descriptions are also slightly more verbose than designed, which is a beneficial deviation.</p>
<h3 id="62-design-document-math-error-not-an-implementation-gap">6.2 Design Document Math Error (Not an implementation gap)</h3>
<p><strong>Design</strong> (Section 4.2, line ~314):
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>F(1 day) = -0.001 * 86400 / 86400 = -1.0
</code></pre></div></p>
<p><strong>Correct calculation</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>raw = -0.001 * 86400 = -86.4
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>clamped = max(-86.4, -86400.0) = -86.4
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>F = -86.4 / abs(-86400.0) = -86.4 / 86400.0 = -0.001
</code></pre></div></p>
<p>The proof incorrectly treats <code>freshness_floor</code> as if it were <code>-86400.0 / 86400 = -1.0</code> directly, but the normalization step divides the <em>clamped raw value</em> by <code>abs(floor)</code>, not <code>floor</code> by itself.</p>
<p><strong>Actual behavior with defaults</strong>:
| Time elapsed | raw | clamped | F(m) |
|-------------|-----|---------|------|
| 0 (just recalled) | 0.0 | 0.0 | 0.0 |
| 1 hour | -3.6 | -3.6 | -0.0000417 |
| 1 day | -86.4 | -86.4 | -0.001 |
| 30 days | -2592.0 | -2592.0 | -0.03 |
| 365 days | -31536.0 | -31536.0 | -0.365 |
| ~1000 days | -86400.0 | -86400.0 | -1.0 |</p>
<p><strong>Impact</strong>: Medium. The black hole prevention still works (freshness eventually reaches -1.0), but the decay is <strong>much slower</strong> than the design prose suggests. A memory takes ~1000 days to reach F = -1.0 instead of the claimed 1 day. This affects the scenarios in Section 4.3 but does NOT affect the correctness of the implementation since the implementation matches the code specification.</p>
<hr />
<h2 id="7-recommended-actions">7. Recommended Actions</h2>
<h3 id="71-optional-code-fix-low-priority">7.1 Optional Code Fix (Low Priority)</h3>
<table>
<thead>
<tr>
<th>#</th>
<th>Item</th>
<th>File</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>OpenAI adapter consistency</td>
<td><code>adapters/openai.py</code></td>
<td>Either update design to include <code>score</code> field (recommended) or remove from implementation</td>
</tr>
</tbody>
</table>
<h3 id="72-design-document-updates-needed">7.2 Design Document Updates Needed</h3>
<table>
<thead>
<tr>
<th>#</th>
<th>Item</th>
<th>Section</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Fix math proof</td>
<td>Section 4.2</td>
<td>Correct <code>F(1 day) = -0.001</code> not <code>-1.0</code>; update freshness_floor semantics</td>
</tr>
<tr>
<td>2</td>
<td>Fix scenarios</td>
<td>Section 4.3</td>
<td>Update "1 day -&gt; F = -1.0" to reflect actual decay rate</td>
</tr>
<tr>
<td>3</td>
<td>Add score to OpenAI spec</td>
<td>Section 10.2</td>
<td>Add <code>score</code> field to handle_tool_call responses</td>
</tr>
<tr>
<td>4</td>
<td>Fix file paths</td>
<td>Sections 5.1, 8.1</td>
<td>Update <code>zones.py</code> -&gt; <code>models.py</code>, <code>storage/base.py</code> -&gt; <code>storage/__init__.py</code></td>
</tr>
<tr>
<td>5</td>
<td>Document added features</td>
<td>N/A</td>
<td>Document <code>find_item()</code>, <code>_clamp_zone()</code>, <code>close()</code>, thread safety</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="8-next-steps">8. Next Steps</h2>
<ul>
<li>[x] Gap analysis complete</li>
<li>[ ] Update design document Section 4.2 math proof</li>
<li>[ ] Update design document Section 4.3 scenarios</li>
<li>[ ] Update design document Sections 5.1 and 8.1 file paths</li>
<li>[ ] Update design document Section 10.2 OpenAI response format</li>
<li>[ ] Proceed to <code>/pdca report celestial-memory-engine</code></li>
</ul>
<hr />
<h2 id="version-history">Version History</h2>
<table>
<thead>
<tr>
<th>Version</th>
<th>Date</th>
<th>Changes</th>
<th>Author</th>
</tr>
</thead>
<tbody>
<tr>
<td>0.1</td>
<td>2026-02-18</td>
<td>Initial analysis -- 97.5% match rate (19.5/20)</td>
<td>gap-detector</td>
</tr>
</tbody>
</table>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": ["content.code.copy", "navigation.sections", "search.suggest", "navigation.top"], "search": "../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>